"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[221],{67893:function(t,e,n){n(12419),n(47941),n(82526),n(57327),n(38880),n(49337);var r=n(48926),i=n(93913),a=n(81506),s=n(2205),u=n(78585),o=n(29754),c=n(59713),d=n(34575);n(41539),n(88674),n(54747),n(9653);var l=n(87757),f=n(50008);n(92222),n(91038),n(78783);var p=n(2043),h=n(42604);n(21249),n(66992),n(33948),n(74916),n(15306),n(69600);var v=n(93431),y=n(9528),m=n(69098);n(47042),n(68309),n(41817),n(32165);var g=n(63038);n(51532);var b=n(89575),k=n(7766),w=n(54122),x=n(34929),_=n(34452),S=n(319);n(70189),n(26699),n(33161),n(82472),n(92990),n(18927),n(33105),n(35035),n(74345),n(7174),n(32846),n(44731),n(77209),n(96319),n(58867),n(37789),n(33739),n(29368),n(14483),n(12056),n(3462),n(30678),n(27462),n(33824),n(55021),n(12974),n(15016),n(18264),n(2707),n(32023),n(69826),n(40561),n(69720);var C=n(55877);function P(t){return t&&"object"===typeof t&&"default"in t?t:{default:t}}function R(t){if(t&&t.__esModule)return t;var e=Object.create(null);return t&&Object.keys(t).forEach((function(n){if("default"!==n){var r=Object.getOwnPropertyDescriptor(t,n);Object.defineProperty(e,n,r.get?r:{enumerable:!0,get:function(){return t[n]}})}})),e.default=t,Object.freeze(e)}var E=P(r),T=P(i),O=P(a),U=P(s),I=P(u),N=P(o),M=P(c),j=P(d),A=P(l),D=P(f),F=R(p),B=R(v),L=P(g),z=P(S);function J(t,e,n,r){var i,a=arguments.length,s=a<3?e:null===r?r=Object.getOwnPropertyDescriptor(e,n):r;if("object"===("undefined"===typeof Reflect?"undefined":D.default(Reflect))&&"function"===typeof Reflect.decorate)s=Reflect.decorate(t,e,n,r);else for(var u=t.length-1;u>=0;u--)(i=t[u])&&(s=(a<3?i(s):a>3?i(e,n,s):i(e,n))||s);return a>3&&s&&Object.defineProperty(e,n,s),s}function q(t,e){if("object"===("undefined"===typeof Reflect?"undefined":D.default(Reflect))&&"function"===typeof Reflect.metadata)return Reflect.metadata(t,e)}function G(t,e){return["".concat((new Date).toISOString()," Conversations ").concat(t,":")].concat(Array.from(e))}var K=F.getLogger("twilio-conversations"),V=function(){function t(e){j.default(this,t),M.default(this,"prefix",""),this.prefix=null!==e&&void 0!==e&&e.length>0?e+" ":""}return T.default(t,[{key:"setLevel",value:function(t){K.setLevel(t)}},{key:"trace",value:function(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];K.trace.apply(null,G(this.prefix+"T",e))}},{key:"debug",value:function(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];K.debug.apply(null,G(this.prefix+"D",e))}},{key:"info",value:function(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];K.info.apply(null,G(this.prefix+"I",e))}},{key:"warn",value:function(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];K.warn.apply(null,G(this.prefix+"W",e))}},{key:"error",value:function(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];K.error.apply(null,G(this.prefix+"E",e))}}],[{key:"scope",value:function(e){return new t(e)}},{key:"setLevel",value:function(t){K.setLevel(t)}},{key:"trace",value:function(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];K.trace.apply(null,G("T",e))}},{key:"debug",value:function(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];K.debug.apply(null,G("D",e))}},{key:"info",value:function(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];K.info.apply(null,G("I",e))}},{key:"warn",value:function(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];K.warn.apply(null,G("W",e))}},{key:"error",value:function(){for(var t=arguments.length,e=new Array(t),n=0;n<t;n++)e[n]=arguments[n];K.error.apply(null,G("E",e))}}]),t}();function W(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,r)}return n}function $(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?W(Object(n),!0).forEach((function(e){M.default(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):W(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}var Y="PT5S",H="PT5S",X=function t(){var e,n,r,i,a,s,u=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},o=arguments.length>1?arguments[1]:void 0,c=arguments.length>2?arguments[2]:void 0;j.default(this,t),M.default(this,"typingIndicatorTimeoutDefault",5e3);var d=u.Chat||u.IPMessaging||u||{};this.productId=d.productId,this.links={myConversations:o.links.my_conversations,conversations:o.links.conversations,users:o.links.users,currentUser:o.links.current_user,typing:o.links.typing,mediaService:o.links.media_service,mediaSetService:o.links.media_set_service,messagesReceipts:o.links.messages_receipts},this.limits={mediaAttachmentsCountLimit:o.options.media_attachments_count_limit,mediaAttachmentSizeLimitInMb:o.options.media_attachment_size_limit_in_mb,mediaAttachmentsTotalSizeLimitInMb:o.options.media_attachments_total_size_limit_in_mb,emailHistoriesAllowedMimeTypes:o.options.email_histories_allowed_mime_types,emailBodiesAllowedMimeTypes:o.options.email_bodies_allowed_mime_types},this.typingIndicatorTimeoutOverride=d.typingIndicatorTimeoutOverride,this.backoffConfiguration=$({min:1e3,max:4e3,maxAttemptsCount:3},d.backoffConfigOverride),this.retryWhenThrottled=void 0===d.retryWhenThrottledOverride||d.retryWhenThrottledOverride,this.userInfosToSubscribe=null!==(e=null!==(n=d.userInfosToSubscribeOverride)&&void 0!==n?n:o.options.user_infos_to_subscribe)&&void 0!==e?e:100,this.reachabilityEnabled=o.options.reachability_enabled,this.userIdentity=o.identity,this.userInfo=o.sync_objects.my_user_info,this.myConversations=o.sync_objects.my_conversations;var l=null!==(r=null!==(i=d.httpCacheIntervalOverride)&&void 0!==i?i:o.options.http_cache_interval)&&void 0!==r?r:Y;try{this.httpCacheInterval=h.toSeconds(h.parse(l))}catch(p){c.error("Failed to parse http cache interval ".concat(l,", using default value ").concat(Y)),this.httpCacheInterval=h.toSeconds(h.parse(Y))}var f=null!==(a=null!==(s=d.consumptionReportIntervalOverride)&&void 0!==s?s:o.options.consumption_report_interval)&&void 0!==a?a:H;try{this.consumptionReportInterval=h.toSeconds(h.parse(f))}catch(v){c.error("Failed to parse consumption report interval ".concat(f,", using default value ").concat(H)),this.consumptionReportInterval=h.toSeconds(h.parse(H))}};function Z(t,e){return 0===B.createPatch(t,e).length}function Q(t){return JSON.parse(JSON.stringify(t))}function tt(t){return"undefined"===typeof t||isNaN(Number(t))?null:Number(t)}function et(t){try{return new Date(t)}catch(e){return null}}function nt(t,e,n){var r={};if(t)try{r=JSON.parse(t)}catch(i){n.warn(e,i)}return r}var rt=function(){function t(e){j.default(this,t),this.base=e.replace(/\/$/,""),this.args=[],this.paths=[]}return T.default(t,[{key:"arg",value:function(t,e){return"undefined"!==typeof e&&this.args.push(encodeURIComponent(t)+"="+encodeURIComponent(e)),this}},{key:"path",value:function(t){return this.paths.push(encodeURIComponent(t)),this}},{key:"build",value:function(){var t=this.base;return this.paths.length&&(t+="/"+this.paths.join("/")),this.args.length&&(t+="?"+this.args.join("&")),t}}]),t}();function it(t){var e=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}();return function(){var n,r=N.default(t);if(e){var i=N.default(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return I.default(this,n)}}var at=V.scope("User"),st=function(t){U.default(n,t);var e=it(n);function n(t,r,i,a){var s;return j.default(this,n),s=e.call(this),M.default(O.default(s),"promiseToFetch",null),M.default(O.default(s),"updated","updated"),M.default(O.default(s),"userSubscribed","userSubscribed"),M.default(O.default(s),"userUnsubscribed","userUnsubscribed"),s.services=a,s.subscribed="initializing",s.setMaxListeners(0),s.state={identity:t,entityName:r,friendlyName:null,attributes:{},online:null,notifiable:null},s._initializationPromise=new Promise((function(t){s._resolveInitializationPromise=t})),null!==i&&s._resolveInitialization(i,t,r,!1),s}return T.default(n,[{key:"identity",get:function(){return this.state.identity},set:function(t){this.state.identity=t}},{key:"entityName",set:function(t){this.state.entityName=t}},{key:"attributes",get:function(){return this.state.attributes}},{key:"friendlyName",get:function(){return this.state.friendlyName}},{key:"isOnline",get:function(){return this.state.online}},{key:"isNotifiable",get:function(){return this.state.notifiable}},{key:"isSubscribed",get:function(){return"subscribed"==this.subscribed}},{key:"_update",value:function(){var t=E.default(A.default.mark((function t(e,n){var r,i;return A.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this._initializationPromise;case 2:r=[],at.debug("User for",this.state.identity,"updated:",e,n),t.t0=e,t.next="friendlyName"===t.t0?7:"attributes"===t.t0?9:"reachability"===t.t0?12:15;break;case 7:return this.state.friendlyName!==n.value&&(r.push("friendlyName"),this.state.friendlyName=n.value),t.abrupt("break",16);case 9:return i=nt(n.value,"Retrieved malformed attributes from the server for user: ".concat(this.state.identity),at),Z(this.state.attributes,i)||(this.state.attributes=i,r.push("attributes")),t.abrupt("break",16);case 12:return this.state.online!==n.online&&(this.state.online=n.online,r.push("reachabilityOnline")),this.state.notifiable!==n.notifiable&&(this.state.notifiable=n.notifiable,r.push("reachabilityNotifiable")),t.abrupt("break",16);case 15:return t.abrupt("return");case 16:r.length>0&&this.emit("updated",{user:this,updateReasons:r});case 17:case"end":return t.stop()}}),t,this)})));return function(e,n){return t.apply(this,arguments)}}()},{key:"_updateReachabilityInfo",value:function(){var t=E.default(A.default.mark((function t(e,n){var r=this;return A.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this._initializationPromise;case 2:if(this.configuration.reachabilityEnabled){t.next=4;break}return t.abrupt("return",Promise.resolve());case 4:return t.abrupt("return",e.get("reachability").then(n).catch((function(t){at.warn("Failed to get reachability info for ",r.state.identity,t)})));case 5:case"end":return t.stop()}}),t,this)})));return function(e,n){return t.apply(this,arguments)}}()},{key:"_fetch",value:function(){var t=E.default(A.default.mark((function t(){var e=this;return A.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this._initializationPromise;case 2:if(this.state.entityName){t.next=4;break}return t.abrupt("return",this);case 4:return this.promiseToFetch=this.services.syncClient.map({id:this.state.entityName,mode:"open_existing",includeItems:!0}).then((function(t){return e.entity=t,t.on("itemUpdated",(function(t){return at.debug(e.state.entityName+" ("+e.state.identity+") itemUpdated: "+t.item.key),e._update(t.item.key,t.item.data)})),Promise.all([t.get("friendlyName").then((function(t){return e._update(t.key,t.data)})),t.get("attributes").then((function(t){return e._update(t.key,t.data)})),e._updateReachabilityInfo(t,(function(t){return e._update(t.key,t.data)}))])})).then((function(){return at.debug("Fetched for",e.identity),e.subscribed="subscribed",e.emit("userSubscribed",e),e})).catch((function(t){throw e.promiseToFetch=null,t})),t.abrupt("return",this.promiseToFetch);case 6:case"end":return t.stop()}}),t,this)})));return function(){return t.apply(this,arguments)}}()},{key:"_ensureFetched",value:function(){var t=E.default(A.default.mark((function t(){return A.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this._initializationPromise;case 2:return t.abrupt("return",this.promiseToFetch||this._fetch());case 3:case"end":return t.stop()}}),t,this)})));return function(){return t.apply(this,arguments)}}()},{key:"updateAttributes",value:function(){var t=E.default(A.default.mark((function t(e){return A.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this._initializationPromise;case 2:if("unsubscribed"!=this.subscribed){t.next=4;break}throw new Error("Can't modify unsubscribed object");case 4:return t.next=6,this.services.commandExecutor.mutateResource("post",this.links.self,{attributes:JSON.stringify(e)});case 6:return t.abrupt("return",this);case 7:case"end":return t.stop()}}),t,this)})));return function(e){return t.apply(this,arguments)}}()},{key:"updateFriendlyName",value:function(){var t=E.default(A.default.mark((function t(e){return A.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this._initializationPromise;case 2:if("unsubscribed"!=this.subscribed){t.next=4;break}throw new Error("Can't modify unsubscribed object");case 4:return t.next=6,this.services.commandExecutor.mutateResource("post",this.links.self,{friendly_name:e});case 6:return t.abrupt("return",this);case 7:case"end":return t.stop()}}),t,this)})));return function(e){return t.apply(this,arguments)}}()},{key:"unsubscribe",value:function(){var t=E.default(A.default.mark((function t(){return A.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this._initializationPromise;case 2:if(!this.promiseToFetch){t.next=9;break}return t.next=5,this.promiseToFetch;case 5:this.entity.close(),this.promiseToFetch=null,this.subscribed="unsubscribed",this.emit("userUnsubscribed",this);case 9:case"end":return t.stop()}}),t,this)})));return function(){return t.apply(this,arguments)}}()},{key:"_resolveInitialization",value:function(t,e,n,r){this.configuration=t,this.identity=e,this.entityName=n,this.links={self:"".concat(this.configuration.links.users,"/").concat(this.identity)},this._resolveInitializationPromise(),r&&this.emit("updated",{user:this,updateReasons:["friendlyName","attributes","reachabilityOnline","reachabilityNotifiable"]})}}]),n}(m.ReplayEventEmitter);function ut(t,e){var n="undefined"!==typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!n){if(Array.isArray(t)||(n=function(t,e){if(!t)return;if("string"===typeof t)return ot(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);"Object"===n&&t.constructor&&(n=t.constructor.name);if("Map"===n||"Set"===n)return Array.from(t);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return ot(t,e)}(t))||e&&t&&"number"===typeof t.length){n&&(t=n);var r=0,i=function(){};return{s:i,n:function(){return r>=t.length?{done:!0}:{done:!1,value:t[r++]}},e:function(t){throw t},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,s=!0,u=!1;return{s:function(){n=n.call(t)},n:function(){var t=n.next();return s=t.done,t},e:function(t){u=!0,a=t},f:function(){try{s||null==n.return||n.return()}finally{if(u)throw a}}}}function ot(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,r=new Array(e);n<e;n++)r[n]=t[n];return r}J([y.validateTypesAsync(["string","number","boolean","object",y.literal(null)]),q("design:type",Function),q("design:paramtypes",[Object]),q("design:returntype",Promise)],st.prototype,"updateAttributes",null),J([y.validateTypesAsync(["string"]),q("design:type",Function),q("design:paramtypes",[String]),q("design:returntype",Promise)],st.prototype,"updateFriendlyName",null);var ct=function(){function t(e,n){j.default(this,t),this.configuration=e,this.services=n,this.cache=new Map,this.cacheLifetime=100*this.configuration.httpCacheInterval,this.cleanupCache()}return T.default(t,[{key:"isExpired",value:function(t){return!this.cacheLifetime||Date.now()-t>this.cacheLifetime}},{key:"cleanupCache",value:function(){var t,e=ut(this.cache);try{for(e.s();!(t=e.n()).done;){var n=L.default(t.value,2),r=n[0],i=n[1];this.isExpired(i.timestamp)&&this.cache.delete(r)}}catch(a){e.e(a)}finally{e.f()}0===this.cache.size&&clearInterval(this.timer)}},{key:"pokeTimer",value:function(){var t=this;this.timer=this.timer||setInterval((function(){return t.cleanupCache()}),2*this.cacheLifetime)}},{key:"executeWithRetry",value:function(t){var e=this,n=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return new Promise((function(r,i){var a=[502,503,504];n&&a.push(429);var s=new b.Retrier(e.configuration.backoffConfiguration);s.on("attempt",(function(){t().then((function(t){return s.succeeded(t)})).catch((function(t){a.indexOf(t.status)>-1||"Twilsock disconnected"===t.message?s.failed(t):(s.removeAllListeners(),s.cancel(),i(t))}))})),s.on("succeeded",(function(t){r(t)})),s.on("cancelled",(function(t){return i(t)})),s.on("failed",(function(t){return i(t)})),s.start()}))}},{key:"get",value:function(){var t=E.default(A.default.mark((function t(e){var n,r,i,a=this;return A.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!(n=this.cache.get(e))||this.isExpired(n.timestamp)){t.next=3;break}return t.abrupt("return",n.response);case 3:return r={},t.next=6,this.executeWithRetry((function(){return a.services.transport.get(e,r,a.configuration.productId)}),this.configuration.retryWhenThrottled);case 6:return i=t.sent,this.cache.set(e,{response:i,timestamp:Date.now()}),this.pokeTimer(),t.abrupt("return",i);case 10:case"end":return t.stop()}}),t,this)})));return function(e){return t.apply(this,arguments)}}()}]),t}(),dt=function t(){j.default(this,t)};function lt(t){var e=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}();return function(){var n,r=N.default(t);if(e){var i=N.default(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return I.default(this,n)}}M.default(dt,"TYPING_INDICATOR","twilio.ipmsg.typing_indicator"),M.default(dt,"NEW_MESSAGE","twilio.conversations.new_message"),M.default(dt,"ADDED_TO_CONVERSATION","twilio.conversations.added_to_conversation"),M.default(dt,"REMOVED_FROM_CONVERSATION","twilio.conversations.removed_from_conversation"),M.default(dt,"CONSUMPTION_UPDATE","twilio.channel.consumption_update");var ft=V.scope("Participant"),pt=function(t){U.default(n,t);var e=lt(n);function n(t,r,i,a,s){var u;if(j.default(this,n),(u=e.call(this)).conversation=i,u.links=a,u.services=s,u.state={attributes:nt(t.attributes,"Retrieved malformed attributes from the server for participant: "+r,ft),dateCreated:t.dateCreated?et(t.dateCreated):null,dateUpdated:t.dateCreated?et(t.dateUpdated):null,sid:r,typingTimeout:null,isTyping:!1,identity:t.identity||null,roleSid:t.roleSid||null,lastReadMessageIndex:Number.isInteger(t.lastConsumedMessageIndex)?t.lastConsumedMessageIndex:null,lastReadTimestamp:t.lastConsumptionTimestamp?et(t.lastConsumptionTimestamp):null,type:t.type||"chat",userInfo:t.userInfo},!t.identity&&!t.type)throw new Error("Received invalid Participant object from server: Missing identity or type of Participant.");return u}return T.default(n,[{key:"sid",get:function(){return this.state.sid}},{key:"attributes",get:function(){return this.state.attributes}},{key:"dateCreated",get:function(){return this.state.dateCreated}},{key:"dateUpdated",get:function(){return this.state.dateUpdated}},{key:"identity",get:function(){return this.state.identity}},{key:"isTyping",get:function(){return this.state.isTyping}},{key:"lastReadMessageIndex",get:function(){return this.state.lastReadMessageIndex}},{key:"lastReadTimestamp",get:function(){return this.state.lastReadTimestamp}},{key:"roleSid",get:function(){return this.state.roleSid}},{key:"type",get:function(){return this.state.type}},{key:"_startTyping",value:function(t){var e=this;return clearTimeout(this.state.typingTimeout),this.state.isTyping=!0,this.emit("typingStarted",this),this.conversation.emit("typingStarted",this),this.state.typingTimeout=setTimeout((function(){return e._endTyping()}),t),this}},{key:"_endTyping",value:function(){this.state.typingTimeout&&(this.state.isTyping=!1,this.emit("typingEnded",this),this.conversation.emit("typingEnded",this),clearInterval(this.state.typingTimeout),this.state.typingTimeout=null)}},{key:"_update",value:function(t){var e=[],n=nt(t.attributes,"Retrieved malformed attributes from the server for participant: "+this.state.sid,ft);t.attributes&&!Z(this.state.attributes,n)&&(this.state.attributes=n,e.push("attributes"));var r=et(t.dateUpdated);t.dateUpdated&&r.getTime()!==(this.state.dateUpdated&&this.state.dateUpdated.getTime())&&(this.state.dateUpdated=r,e.push("dateUpdated"));var i=et(t.dateCreated);if(t.dateCreated&&i.getTime()!==(this.state.dateCreated&&this.state.dateCreated.getTime())&&(this.state.dateCreated=i,e.push("dateCreated")),t.roleSid&&this.state.roleSid!==t.roleSid&&(this.state.roleSid=t.roleSid,e.push("roleSid")),!Number.isInteger(t.lastConsumedMessageIndex)&&null!==t.lastConsumedMessageIndex||this.state.lastReadMessageIndex===t.lastConsumedMessageIndex||(this.state.lastReadMessageIndex=t.lastConsumedMessageIndex,e.push("lastReadMessageIndex")),t.lastConsumptionTimestamp){var a=new Date(t.lastConsumptionTimestamp);this.state.lastReadTimestamp&&this.state.lastReadTimestamp.getTime()===a.getTime()||(this.state.lastReadTimestamp=a,e.push("lastReadTimestamp"))}return e.length>0&&this.emit("updated",{participant:this,updateReasons:e}),this}},{key:"getUser",value:function(){var t=E.default(A.default.mark((function t(){return A.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if("chat"==this.type){t.next=2;break}throw new Error("Getting User is not supported for this Participant type: "+this.type);case 2:return t.abrupt("return",this.services.users.getUser(this.state.identity,this.state.userInfo));case 3:case"end":return t.stop()}}),t,this)})));return function(){return t.apply(this,arguments)}}()},{key:"remove",value:function(){var t=E.default(A.default.mark((function t(){return A.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",this.conversation.removeParticipant(this));case 1:case"end":return t.stop()}}),t,this)})));return function(){return t.apply(this,arguments)}}()},{key:"updateAttributes",value:function(){var t=E.default(A.default.mark((function t(e){return A.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this.services.commandExecutor.mutateResource("post",this.links.self,{attributes:JSON.stringify(e)});case 2:return t.abrupt("return",this);case 3:case"end":return t.stop()}}),t,this)})));return function(e){return t.apply(this,arguments)}}()}]),n}(m.ReplayEventEmitter);function ht(t){var e=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}();return function(){var n,r=N.default(t);if(e){var i=N.default(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return I.default(this,n)}}M.default(pt,"typingStarted","typingStarted"),M.default(pt,"typingEnded","typingEnded"),M.default(pt,"updated","updated"),J([y.validateTypesAsync(["string","number","boolean","object",y.literal(null)]),q("design:type",Function),q("design:paramtypes",[Object]),q("design:returntype",Promise)],pt.prototype,"updateAttributes",null);var vt=V.scope("Participants"),yt=function(t){U.default(n,t);var e=ht(n);function n(t,r,i,a,s){var u;return j.default(this,n),(u=e.call(this)).conversation=t,u.participants=r,u.links=i,u.configuration=a,u.services=s,u}return T.default(n,[{key:"unsubscribe",value:function(){var t=E.default(A.default.mark((function t(){return A.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!this.rosterEntityPromise){t.next=6;break}return t.next=3,this.rosterEntityPromise;case 3:t.sent.close(),this.rosterEntityPromise=null;case 6:case"end":return t.stop()}}),t,this)})));return function(){return t.apply(this,arguments)}}()},{key:"subscribe",value:function(t){var e=this;return this.rosterEntityPromise=this.rosterEntityPromise||this.services.syncClient.map({id:t,mode:"open_existing"}).then((function(t){t.on("itemAdded",(function(t){vt.debug(e.conversation.sid+" itemAdded: "+t.item.key),e.upsertParticipant(t.item.key,t.item.data).then((function(t){e.emit("participantJoined",t)}))})),t.on("itemRemoved",(function(t){vt.debug(e.conversation.sid+" itemRemoved: "+t.key);var n=t.key;if(e.participants.has(n)){var r=e.participants.get(n);e.participants.delete(n),e.emit("participantLeft",r)}})),t.on("itemUpdated",(function(t){vt.debug(e.conversation.sid+" itemUpdated: "+t.item.key),e.upsertParticipant(t.item.key,t.item.data)}));var n=[],r=e;return t.getItems().then((function t(e){return e.items.forEach((function(t){n.push(r.upsertParticipant(t.key,t.data))})),e.hasNextPage?e.nextPage().then(t):null})).then((function(){return Promise.all(n)})).then((function(){return t}))})).catch((function(t){throw e.rosterEntityPromise=null,"disconnected"!=e.services.syncClient.connectionState&&vt.error("Failed to get roster object for conversation",e.conversation.sid,t),vt.debug("ERROR: Failed to get roster object for conversation",e.conversation.sid,t),t}))}},{key:"upsertParticipant",value:function(){var t=E.default(A.default.mark((function t(e,n){var r,i,a=this;return A.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!(r=this.participants.get(e))){t.next=3;break}return t.abrupt("return",r._update(n));case 3:return i={self:"".concat(this.links.participants,"/").concat(e)},r=new pt(n,e,this.conversation,i,this.services),this.participants.set(e,r),r.on("updated",(function(t){return a.emit("participantUpdated",t)})),t.abrupt("return",r);case 8:case"end":return t.stop()}}),t,this)})));return function(e,n){return t.apply(this,arguments)}}()},{key:"getParticipants",value:function(){var t=this;return this.rosterEntityPromise.then((function(){var e=[];return t.participants.forEach((function(t){return e.push(t)})),e}))}},{key:"getParticipantBySid",value:function(){var t=E.default(A.default.mark((function t(e){var n=this;return A.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",this.rosterEntityPromise.then((function(){var t=n.participants.get(e);if(!t)throw new Error("Participant with SID "+e+" was not found");return t})));case 1:case"end":return t.stop()}}),t,this)})));return function(e){return t.apply(this,arguments)}}()},{key:"getParticipantByIdentity",value:function(){var t=E.default(A.default.mark((function t(e){var n,r=this;return A.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n=null,t.abrupt("return",this.rosterEntityPromise.then((function(){if(r.participants.forEach((function(t){t.identity===e&&(n=t)})),!n)throw new Error("Participant with identity "+e+" was not found");return n})));case 2:case"end":return t.stop()}}),t,this)})));return function(e){return t.apply(this,arguments)}}()},{key:"add",value:function(){var t=E.default(A.default.mark((function t(e,n){return A.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this.services.commandExecutor.mutateResource("post",this.links.participants,{identity:e,attributes:"undefined"!==typeof n?JSON.stringify(n):void 0});case 2:return t.abrupt("return",t.sent);case 3:case"end":return t.stop()}}),t,this)})));return function(e,n){return t.apply(this,arguments)}}()},{key:"addNonChatParticipant",value:function(t,e,n){return this.services.commandExecutor.mutateResource("post",this.links.participants,{attributes:"undefined"!==typeof n?JSON.stringify(n):void 0,messaging_binding:{address:e,proxy_address:t}})}},{key:"remove",value:function(t){return this.services.commandExecutor.mutateResource("delete","".concat(this.links.participants,"/").concat(t))}}]),n}(m.ReplayEventEmitter),mt=function(){function t(e,n){j.default(this,t),M.default(this,"mcsMedia",null),this.services=n,e instanceof _.McsMedia&&(this.mcsMedia=e),this.state={sid:e.sid,category:e.category,filename:e.filename,contentType:e.contentType,size:e.size}}return T.default(t,[{key:"sid",get:function(){return this.state.sid}},{key:"filename",get:function(){return this.state.filename}},{key:"contentType",get:function(){return this.state.contentType}},{key:"size",get:function(){return this.state.size}},{key:"category",get:function(){return this.state.category}},{key:"getContentTemporaryUrl",value:function(){var t=E.default(A.default.mark((function t(){return A.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this._fetchMcsMedia();case 2:return t.abrupt("return",this.mcsMedia.getContentUrl());case 3:case"end":return t.stop()}}),t,this)})));return function(){return t.apply(this,arguments)}}()},{key:"getCachedTemporaryUrl",value:function(){var t=E.default(A.default.mark((function t(){return A.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this._fetchMcsMedia();case 2:return t.abrupt("return",this.mcsMedia.getCachedContentUrl());case 3:case"end":return t.stop()}}),t,this)})));return function(){return t.apply(this,arguments)}}()},{key:"_fetchMcsMedia",value:function(){var t=E.default(A.default.mark((function t(){return A.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(this.mcsMedia){t.next=8;break}if(!this.services.mcsClient){t.next=7;break}return t.next=4,this.services.mcsClient.get(this.state.sid);case 4:this.mcsMedia=t.sent,t.next=8;break;case 7:throw new Error("Media Content Service is unavailable");case 8:case"end":return t.stop()}}),t,this)})));return function(){return t.apply(this,arguments)}}()}]),t}(),gt=function(){function t(e){j.default(this,t),this.state=e}return T.default(t,[{key:"total",get:function(){return this.state.total}},{key:"sent",get:function(){return this.state.sent}},{key:"delivered",get:function(){return this.state.delivered}},{key:"read",get:function(){return this.state.read}},{key:"undelivered",get:function(){return this.state.undelivered}},{key:"failed",get:function(){return this.state.failed}},{key:"_update",value:function(t){this.state=t}},{key:"_isEquals",value:function(t){var e=this.total===t.total,n=this.sent===t.sent,r=this.delivered===t.delivered,i=this.read===t.read,a=this.undelivered===t.undelivered,s=this.failed===t.failed;return e&&n&&r&&i&&a&&s}}]),t}(),bt=function(){function t(e,n,r,i){j.default(this,t),this.state={prevToken:r,nextToken:i,source:n,items:e}}return T.default(t,[{key:"hasNextPage",get:function(){return!!this.state.nextToken}},{key:"hasPrevPage",get:function(){return!!this.state.prevToken}},{key:"items",get:function(){return this.state.items}},{key:"nextPage",value:function(){return this.hasNextPage?this.state.source(this.state.nextToken):Promise.reject(new Error("No next page"))}},{key:"prevPage",value:function(){return this.hasPrevPage?this.state.source(this.state.prevToken):Promise.reject(new Error("No previous page"))}}]),t}(),kt=function t(e){j.default(this,t),this.sid=e.sid,this.messageSid=e.message_sid,this.conversationSid=e.conversation_sid,this.channelMessageSid=e.channel_message_sid,this.participantSid=e.participant_sid,this.status=e.status||"queued",this.errorCode=e.error_code||0,this.dateCreated=e.date_created,this.dateUpdated=e.date_updated};function wt(t){var e=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}();return function(){var n,r=N.default(t);if(e){var i=N.default(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return I.default(this,n)}}var xt=V.scope("Message"),_t=function(t){U.default(n,t);var e=wt(n);function n(t,r,i,a,s,u){var o,c,d,l,f,p;return j.default(this,n),(p=e.call(this)).conversation=i,p.links=a,p.configuration=s,p.services=u,p.state={sid:r.sid,index:t,author:null!==(o=r.author)&&void 0!==o?o:null,subject:null!==(c=r.subject)&&void 0!==c?c:null,body:r.text,timestamp:r.timestamp?new Date(r.timestamp):null,dateUpdated:r.dateUpdated?new Date(r.dateUpdated):null,lastUpdatedBy:null!==(d=r.lastUpdatedBy)&&void 0!==d?d:null,attributes:nt(r.attributes,"Got malformed attributes for the message ".concat(r.sid),xt),type:null!==(l=r.type)&&void 0!==l?l:"text",media:r.type&&"media"===r.type&&r.media?new mt(r.media,p.services):null,medias:r.type&&"media"===r.type&&r.medias?r.medias.map((function(t){return new mt(t,p.services)})):null,participantSid:null!==(f=r.memberSid)&&void 0!==f?f:null,aggregatedDeliveryReceipt:r.delivery?new gt(r.delivery):null},p}return T.default(n,[{key:"sid",get:function(){return this.state.sid}},{key:"author",get:function(){return this.state.author}},{key:"subject",get:function(){return this.state.subject}},{key:"body",get:function(){return this.state.body}},{key:"dateUpdated",get:function(){return this.state.dateUpdated}},{key:"index",get:function(){return this.state.index}},{key:"lastUpdatedBy",get:function(){return this.state.lastUpdatedBy}},{key:"dateCreated",get:function(){return this.state.timestamp}},{key:"attributes",get:function(){return this.state.attributes}},{key:"type",get:function(){return this.state.type}},{key:"media",get:function(){return this.state.media}},{key:"attachedMedia",get:function(){return this.getMediaByCategory(["media"])}},{key:"participantSid",get:function(){return this.state.participantSid}},{key:"aggregatedDeliveryReceipt",get:function(){return this.state.aggregatedDeliveryReceipt}},{key:"getMediaByCategory",value:function(t){var e;return null===(e=this.state.medias)||void 0===e?void 0:e.filter((function(e){return t.includes(e.category)}))}},{key:"_update",value:function(t){var e=[];!t.text&&"string"!==typeof t.text||t.text===this.state.body||(this.state.body=t.text,e.push("body")),t.subject&&t.subject!==this.state.subject&&(this.state.subject=t.subject,e.push("subject")),t.lastUpdatedBy&&t.lastUpdatedBy!==this.state.lastUpdatedBy&&(this.state.lastUpdatedBy=t.lastUpdatedBy,e.push("lastUpdatedBy")),t.author&&t.author!==this.state.author&&(this.state.author=t.author,e.push("author")),t.dateUpdated&&new Date(t.dateUpdated).getTime()!==(this.state.dateUpdated&&this.state.dateUpdated.getTime())&&(this.state.dateUpdated=new Date(t.dateUpdated),e.push("dateUpdated")),t.timestamp&&new Date(t.timestamp).getTime()!==(this.state.timestamp&&this.state.timestamp.getTime())&&(this.state.timestamp=new Date(t.timestamp),e.push("dateCreated"));var n=nt(t.attributes,"Got malformed attributes for the message ".concat(this.sid),xt);Z(this.state.attributes,n)||(this.state.attributes=n,e.push("attributes"));var r=t.delivery,i=this.state.aggregatedDeliveryReceipt;!!r&&!!r.total&&!!r.delivered&&!!r.failed&&!!r.read&&!!r.sent&&!!r.undelivered&&(i?i._isEquals(r)||(i._update(r),e.push("deliveryReceipt")):(this.state.aggregatedDeliveryReceipt=new gt(r),e.push("deliveryReceipt"))),e.length>0&&this.emit("updated",{message:this,updateReasons:e})}},{key:"getParticipant",value:function(){var t=E.default(A.default.mark((function t(){var e,n,r=this;return A.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(e=null,!this.state.participantSid){t.next=5;break}return t.next=4,this.conversation.getParticipantBySid(this.participantSid).catch((function(){return xt.debug('Participant with sid "'.concat(r.participantSid,'" not found for message ').concat(r.sid)),null}));case 4:e=t.sent;case 5:if(e||!this.state.author){t.next=9;break}return t.next=8,this.conversation.getParticipantByIdentity(this.state.author).catch((function(){return xt.debug('Participant with identity "'.concat(r.author,'" not found for message ').concat(r.sid)),null}));case 8:e=t.sent;case 9:if(!e){t.next=11;break}return t.abrupt("return",e);case 11:throw n="Participant with ",this.state.participantSid&&(n+="SID '"+this.state.participantSid+"' "),this.state.author&&(this.state.participantSid&&(n+="or "),n+="identity '"+this.state.author+"' "),"Participant with "===n&&(n="Participant "),n+="was not found",new Error(n);case 17:case"end":return t.stop()}}),t,this)})));return function(){return t.apply(this,arguments)}}()},{key:"getDetailedDeliveryReceipts",value:function(){var t=E.default(A.default.mark((function t(){var e,n;return A.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this._getDetailedDeliveryReceiptsPaginator();case 2:e=t.sent,n=[];case 4:if(n=[].concat(z.default(n),z.default(e.items)),e.hasNextPage){t.next=8;break}return t.abrupt("break",13);case 8:return t.next=10,e.nextPage();case 10:e=t.sent,t.next=4;break;case 13:return t.abrupt("return",n);case 14:case"end":return t.stop()}}),t,this)})));return function(){return t.apply(this,arguments)}}()},{key:"remove",value:function(){var t=E.default(A.default.mark((function t(){return A.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this.services.commandExecutor.mutateResource("delete",this.links.self);case 2:return t.abrupt("return",this);case 3:case"end":return t.stop()}}),t,this)})));return function(){return t.apply(this,arguments)}}()},{key:"updateBody",value:function(){var t=E.default(A.default.mark((function t(e){return A.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this.services.commandExecutor.mutateResource("post",this.links.self,{body:e});case 2:return t.abrupt("return",this);case 3:case"end":return t.stop()}}),t,this)})));return function(e){return t.apply(this,arguments)}}()},{key:"updateAttributes",value:function(){var t=E.default(A.default.mark((function t(e){return A.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this.services.commandExecutor.mutateResource("post",this.links.self,{attributes:"undefined"!==typeof e?JSON.stringify(e):void 0});case 2:return t.abrupt("return",this);case 3:case"end":return t.stop()}}),t,this)})));return function(e){return t.apply(this,arguments)}}()},{key:"attachTemporaryUrlsFor",value:function(){var t=E.default(A.default.mark((function t(e){var n,r=this;return A.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(n=e.map((function(t){return t.sid})),!this.services.mcsClient){t.next=7;break}return t.next=4,this.services.mcsClient.mediaSetGet(n);case 4:return t.abrupt("return",t.sent.map((function(t){return new mt(t,r.services)})));case 7:throw new Error("Media Content Service is unavailable");case 8:case"end":return t.stop()}}),t,this)})));return function(e){return t.apply(this,arguments)}}()},{key:"_getDetailedDeliveryReceiptsPaginator",value:function(){var t=E.default(A.default.mark((function t(e){var n,r,i,a=this;return A.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n=this.configuration.links.messagesReceipts.replace("%s",this.conversation.sid).replace("%s",this.sid),r=new rt(n).arg("PageToken",null===e||void 0===e?void 0:e.pageToken).arg("PageSize",null===e||void 0===e?void 0:e.pageSize).build(),t.next=4,this.services.network.get(r);case 4:return i=t.sent,t.abrupt("return",new bt(i.body.delivery_receipts.map((function(t){return new kt(t)})),(function(t,e){return a._getDetailedDeliveryReceiptsPaginator({pageToken:t,pageSize:e})}),i.body.meta.previous_token,i.body.meta.next_token));case 6:case"end":return t.stop()}}),t,this)})));return function(e){return t.apply(this,arguments)}}()}]),n}(m.ReplayEventEmitter);function St(t,e){var n="undefined"!==typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!n){if(Array.isArray(t)||(n=function(t,e){if(!t)return;if("string"===typeof t)return Ct(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);"Object"===n&&t.constructor&&(n=t.constructor.name);if("Map"===n||"Set"===n)return Array.from(t);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return Ct(t,e)}(t))||e&&t&&"number"===typeof t.length){n&&(t=n);var r=0,i=function(){};return{s:i,n:function(){return r>=t.length?{done:!0}:{done:!1,value:t[r++]}},e:function(t){throw t},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,s=!0,u=!1;return{s:function(){n=n.call(t)},n:function(){var t=n.next();return s=t.done,t},e:function(t){u=!0,a=t},f:function(){try{s||null==n.return||n.return()}finally{if(u)throw a}}}}function Ct(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,r=new Array(e);n<e;n++)r[n]=t[n];return r}function Pt(t){var e=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}();return function(){var n,r=N.default(t);if(e){var i=N.default(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return I.default(this,n)}}M.default(_t,"updated","updated"),J([y.validateTypesAsync("string"),q("design:type",Function),q("design:paramtypes",[String]),q("design:returntype",Promise)],_t.prototype,"updateBody",null),J([y.validateTypesAsync(["string","number","boolean","object",y.literal(null)]),q("design:type",Function),q("design:paramtypes",[Object]),q("design:returntype",Promise)],_t.prototype,"updateAttributes",null),J([y.validateTypesAsync(y.custom((function(t){return[t instanceof Array&&t.length>0&&t.reduce((function(t,e){return t&&e instanceof mt})),"a non-empty array of Media"]}))),q("design:type",Function),q("design:paramtypes",[Array]),q("design:returntype",Promise)],_t.prototype,"attachTemporaryUrlsFor",null);var Rt=V.scope("Messages"),Et=function(t){U.default(n,t);var e=Pt(n);function n(t,r,i){var a;return j.default(this,n),(a=e.call(this)).conversation=t,a.configuration=r,a.services=i,a.messagesByIndex=new Map,a.messagesListPromise=null,a}return T.default(n,[{key:"subscribe",value:function(){var t=E.default(A.default.mark((function t(e){var n,r=this;return A.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!this.messagesListPromise){t.next=2;break}return t.abrupt("return",this.messagesListPromise);case 2:return this.messagesListPromise=this.services.syncClient.list({id:e,mode:"open_existing"}),t.prev=3,t.next=6,this.messagesListPromise;case 6:return(n=t.sent).on("itemAdded",(function(t){Rt.debug("".concat(r.conversation.sid," itemAdded: ").concat(t.item.index));var e={self:"".concat(r.conversation.links.messages,"/").concat(t.item.data.sid),conversation:r.conversation.links.self,messages_receipts:"".concat(r.conversation.links.messages,"/").concat(t.item.data.sid,"/Receipts")},n=new _t(t.item.index,t.item.data,r.conversation,e,r.configuration,r.services);r.messagesByIndex.has(n.index)?Rt.debug("Message arrived, but is already known and ignored",r.conversation.sid,n.index):(r.messagesByIndex.set(n.index,n),n.on("updated",(function(t){return r.emit("messageUpdated",t)})),r.emit("messageAdded",n))})),n.on("itemRemoved",(function(t){Rt.debug("#{this.conversation.sid} itemRemoved: ".concat(t.index));var e=t.index;if(r.messagesByIndex.has(e)){var n=r.messagesByIndex.get(e);r.messagesByIndex.delete(n.index),n.removeAllListeners("updated"),r.emit("messageRemoved",n)}})),n.on("itemUpdated",(function(t){Rt.debug("".concat(r.conversation.sid," itemUpdated: ").concat(t.item.index));var e=r.messagesByIndex.get(t.item.index);e&&e._update(t.item.data)})),t.abrupt("return",n);case 13:throw t.prev=13,t.t0=t.catch(3),this.messagesListPromise=null,"disconnected"!==this.services.syncClient.connectionState&&Rt.error("Failed to get messages object for conversation",this.conversation.sid,t.t0),Rt.debug("ERROR: Failed to get messages object for conversation",this.conversation.sid,t.t0),t.t0;case 19:case"end":return t.stop()}}),t,this,[[3,13]])})));return function(e){return t.apply(this,arguments)}}()},{key:"unsubscribe",value:function(){var t=E.default(A.default.mark((function t(){return A.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(this.messagesListPromise){t.next=2;break}return t.abrupt("return");case 2:return t.next=4,this.messagesListPromise;case 4:t.sent.close(),this.messagesListPromise=null;case 7:case"end":return t.stop()}}),t,this)})));return function(){return t.apply(this,arguments)}}()},{key:"sendV2",value:function(){var t=E.default(A.default.mark((function t(e){var n,r,i,a,s,u,o;return A.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:Rt.debug("Sending message V2",e.mediaContent,e.attributes,e.emailOptions),r=[],i=St(e.mediaContent),t.prev=3,i.s();case 5:if((a=i.n()).done){t.next=22;break}if(s=L.default(a.value,2),u=s[0],o=s[1],Rt.debug("Adding media to a message as ".concat(o instanceof FormData?"FormData":"SendMediaOptions"),o),t.t0=r,!(o instanceof FormData)){t.next=15;break}return t.next=12,this.services.mcsClient.postFormData(o,u);case 12:t.t1=t.sent,t.next=18;break;case 15:return t.next=17,this.services.mcsClient.post(o.contentType,o.media,u,o.filename);case 17:t.t1=t.sent;case 18:t.t2=t.t1,t.t0.push.call(t.t0,t.t2);case 20:t.next=5;break;case 22:t.next=27;break;case 24:t.prev=24,t.t3=t.catch(3),i.e(t.t3);case 27:return t.prev=27,i.f(),t.finish(27);case 30:return t.next=32,this.services.commandExecutor.mutateResource("post",this.conversation.links.messages,{body:e.text,subject:null===(n=e.emailOptions)||void 0===n?void 0:n.subject,media_sids:r.map((function(t){return t.sid})),attributes:"undefined"!==typeof e.attributes?JSON.stringify(e.attributes):void 0});case 32:return t.abrupt("return",t.sent);case 33:case"end":return t.stop()}}),t,this,[[3,24,27,30]])})));return function(e){return t.apply(this,arguments)}}()},{key:"send",value:function(){var t=E.default(A.default.mark((function t(e){var n,r,i=arguments;return A.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n=i.length>1&&void 0!==i[1]?i[1]:{},r=i.length>2?i[2]:void 0,Rt.debug("Sending text message",e,n,r),t.next=5,this.services.commandExecutor.mutateResource("post",this.conversation.links.messages,{body:null!==e&&void 0!==e?e:"",attributes:"undefined"!==typeof n?JSON.stringify(n):void 0,subject:null===r||void 0===r?void 0:r.subject});case 5:return t.abrupt("return",t.sent);case 6:case"end":return t.stop()}}),t,this)})));return function(e){return t.apply(this,arguments)}}()},{key:"sendMedia",value:function(){var t=E.default(A.default.mark((function t(e){var n,r,i,a=arguments;return A.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(n=a.length>1&&void 0!==a[1]?a[1]:{},r=a.length>2?a[2]:void 0,Rt.debug("Sending media message",e,n,r),Rt.debug("Sending media message as ".concat(e instanceof FormData?"FormData":"SendMediaOptions"),e,n),!(e instanceof FormData)){t.next=10;break}return t.next=7,this.services.mcsClient.postFormData(e);case 7:t.t0=t.sent,t.next=13;break;case 10:return t.next=12,this.services.mcsClient.post(e.contentType,e.media,"media",e.filename);case 12:t.t0=t.sent;case 13:return i=t.t0,t.next=16,this.services.commandExecutor.mutateResource("post",this.conversation.links.messages,{media_sids:[i.sid],attributes:"undefined"!==typeof n?JSON.stringify(n):void 0});case 16:return t.abrupt("return",t.sent);case 17:case"end":return t.stop()}}),t,this)})));return function(e){return t.apply(this,arguments)}}()},{key:"getMessages",value:function(){var t=E.default(A.default.mark((function t(e,n){var r,i=arguments;return A.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return r=i.length>2&&void 0!==i[2]?i[2]:"backwards",t.abrupt("return",this._getMessages(e,n,r));case 2:case"end":return t.stop()}}),t,this)})));return function(e,n){return t.apply(this,arguments)}}()},{key:"_wrapPaginator",value:function(t,e,n){var r=this,i="desc"===t,a=function(){return e.nextPage().then((function(e){return r._wrapPaginator(t,e,n)}))},s=function(){return e.prevPage().then((function(e){return r._wrapPaginator(t,e,n)}))};return n(e.items).then((function(t){return{items:t.sort((function(t,e){return t.index-e.index})),hasPrevPage:i?e.hasNextPage:e.hasPrevPage,hasNextPage:i?e.hasPrevPage:e.hasNextPage,prevPage:i?a:s,nextPage:i?s:a}}))}},{key:"_upsertMessage",value:function(t,e){var n=this,r=this.messagesByIndex.get(t);if(r)return r;var i={self:"".concat(this.conversation.links.messages,"/").concat(e.sid),conversation:this.conversation.links.self,messages_receipts:"".concat(this.conversation.links.messages,"/").concat(e.sid,"/Receipts")},a=new _t(t,e,this.conversation,i,this.configuration,this.services);return this.messagesByIndex.set(a.index,a),a.on("updated",(function(t){return n.emit("messageUpdated",t)})),a}},{key:"_getMessages",value:function(){var t=E.default(A.default.mark((function t(){var e,n,r,i,a,s,u=this,o=arguments;return A.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return e=o.length>0&&void 0!==o[0]?o[0]:30,n=o.length>1&&void 0!==o[1]?o[1]:"end",r=o.length>2&&void 0!==o[2]?o[2]:"forward",i="backwards"===r?"desc":"asc",t.next=6,this.messagesListPromise;case 6:return a=t.sent,t.next=9,a.getItems({from:"end"!==n?n:void 0,pageSize:e,order:i,limit:e});case 9:return s=t.sent,t.next=12,this._wrapPaginator(i,s,(function(t){return Promise.all(t.map((function(t){return u._upsertMessage(t.index,t.data)})))}));case 12:return t.abrupt("return",t.sent);case 13:case"end":return t.stop()}}),t,this)})));return function(){return t.apply(this,arguments)}}()}]),n}(m.ReplayEventEmitter),Tt=function(){function t(e){j.default(this,t),M.default(this,"attributes",{}),M.default(this,"mediaContent",[]),M.default(this,"emailOptions",{}),this.messagesEntity=e}return T.default(t,[{key:"send",value:function(){var t=E.default(A.default.mark((function t(){var e;return A.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this.messagesEntity.sendV2(this);case 2:return e=t.sent,t.abrupt("return",tt(e.index));case 4:case"end":return t.stop()}}),t,this)})));return function(){return t.apply(this,arguments)}}()}]),t}(),Ot=function(){function t(e,n){j.default(this,t),this.limits=e,this.message=new Tt(n)}return T.default(t,[{key:"setBody",value:function(t){return this.message.text=t,this}},{key:"setSubject",value:function(t){return this.message.emailOptions.subject=t,this}},{key:"setAttributes",value:function(t){return this.message.attributes=t,this}},{key:"addMedia",value:function(t){return this.message.mediaContent.push(["media",t]),this}},{key:"build",value:function(){if(this.message.mediaContent.length>this.limits.mediaAttachmentsCountLimit)throw new Error("Too many media attachments in the message (".concat(this.message.mediaContent.length," > ").concat(this.limits.mediaAttachmentsCountLimit,")"));return this.message}},{key:"getPayloadContentType",value:function(t){return"undefined"!==typeof FormData&&t instanceof FormData?t.get("Content-Type"):t.contentType}}]),t}();function Ut(t,e){var n="undefined"!==typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!n){if(Array.isArray(t)||(n=function(t,e){if(!t)return;if("string"===typeof t)return It(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);"Object"===n&&t.constructor&&(n=t.constructor.name);if("Map"===n||"Set"===n)return Array.from(t);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return It(t,e)}(t))||e&&t&&"number"===typeof t.length){n&&(t=n);var r=0,i=function(){};return{s:i,n:function(){return r>=t.length?{done:!0}:{done:!1,value:t[r++]}},e:function(t){throw t},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,s=!0,u=!1;return{s:function(){n=n.call(t)},n:function(){var t=n.next();return s=t.done,t},e:function(t){u=!0,a=t},f:function(){try{s||null==n.return||n.return()}finally{if(u)throw a}}}}function It(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,r=new Array(e);n<e;n++)r[n]=t[n];return r}function Nt(t){var e=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}();return function(){var n,r=N.default(t);if(e){var i=N.default(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return I.default(this,n)}}var Mt=V.scope("Conversation"),jt={lastMessage:"lastMessage",attributes:"attributes",createdBy:"createdBy",dateCreated:"dateCreated",dateUpdated:"dateUpdated",friendlyName:"friendlyName",lastConsumedMessageIndex:"lastConsumedMessageIndex",notificationLevel:"notificationLevel",sid:"sid",status:"status",uniqueName:"uniqueName",state:"state"};function At(t){try{return new Date(t)}catch(e){return null}}var Dt=function(t){U.default(n,t);var e=Nt(n);function n(t,r,i,a,s){var u;j.default(this,n),(u=e.call(this)).sid=r,u.links=i,u.configuration=a,u.services=s;var o=t.attributes||{},c=t.createdBy,d=At(t.dateCreated),l=At(t.dateUpdated),f=t.friendlyName||null,p=Number.isInteger(t.lastConsumedMessageIndex)?t.lastConsumedMessageIndex:null,h=t.uniqueName||null;try{JSON.stringify(o)}catch(y){throw new Error("Attributes must be a valid JSON object.")}u.entityName=t.channel,u.channelState={uniqueName:h,status:"notParticipating",attributes:o,createdBy:c,dateCreated:d,dateUpdated:l,friendlyName:f,lastReadMessageIndex:p},t.notificationLevel&&(u.channelState.notificationLevel=t.notificationLevel);var v={participants:u.links.participants};return u.participants=new Map,u.participantsEntity=new yt(O.default(u),u.participants,v,u.configuration,u.services),u.participantsEntity.on("participantJoined",u.emit.bind(O.default(u),"participantJoined")),u.participantsEntity.on("participantLeft",u.emit.bind(O.default(u),"participantLeft")),u.participantsEntity.on("participantUpdated",(function(t){return u.emit("participantUpdated",t)})),u.messagesEntity=new Et(O.default(u),a,s),u.messagesEntity.on("messageAdded",(function(t){return u._onMessageAdded(t)})),u.messagesEntity.on("messageUpdated",(function(t){return u.emit("messageUpdated",t)})),u.messagesEntity.on("messageRemoved",u.emit.bind(O.default(u),"messageRemoved")),u}return T.default(n,[{key:"uniqueName",get:function(){return this.channelState.uniqueName}},{key:"status",get:function(){return this.channelState.status}},{key:"friendlyName",get:function(){return this.channelState.friendlyName}},{key:"dateUpdated",get:function(){return this.channelState.dateUpdated}},{key:"dateCreated",get:function(){return this.channelState.dateCreated}},{key:"createdBy",get:function(){return this.channelState.createdBy}},{key:"attributes",get:function(){return this.channelState.attributes}},{key:"lastReadMessageIndex",get:function(){return this.channelState.lastReadMessageIndex}},{key:"lastMessage",get:function(){return this.channelState.lastMessage}},{key:"notificationLevel",get:function(){return this.channelState.notificationLevel}},{key:"limits",get:function(){return this.configuration.limits}},{key:"state",get:function(){return this.channelState.state}},{key:"_subscribe",value:function(){var t,e=this;return this.entityPromise=null!==(t=this.entityPromise)&&void 0!==t?t:this.services.syncClient.document({id:this.entityName,mode:"open_existing"}).then((function(t){return e.entity=t,e.entity.on("updated",(function(t){e._update(t.data)})),e.entity.on("removed",(function(){return e.emit("removed",e)})),e._update(e.entity.data),t})).catch((function(t){throw e.entity=null,e.entityPromise=null,"disconnected"!=e.services.syncClient.connectionState&&Mt.error("Failed to get conversation object",t),Mt.debug("ERROR: Failed to get conversation object",t),t}))}},{key:"_subscribeStreams",value:function(){var t=E.default(A.default.mark((function t(){var e,n;return A.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,this._subscribe();case 3:return Mt.trace("_subscribeStreams, this.entity.data=",this.entity.data),e=this.entity.data.messages,n=this.entity.data.roster,t.next=8,Promise.all([this.messagesEntity.subscribe(e),this.participantsEntity.subscribe(n)]);case 8:t.next=15;break;case 10:throw t.prev=10,t.t0=t.catch(0),"disconnected"!==this.services.syncClient.connectionState&&Mt.error("Failed to subscribe on conversation objects",this.sid,t.t0),Mt.debug("ERROR: Failed to subscribe on conversation objects",this.sid,t.t0),t.t0;case 15:case"end":return t.stop()}}),t,this,[[0,10]])})));return function(){return t.apply(this,arguments)}}()},{key:"_unsubscribe",value:function(){var t=E.default(A.default.mark((function t(){return A.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!this.entity){t.next=5;break}return t.next=3,this.entity.close();case 3:this.entity=null,this.entityPromise=null;case 5:return t.abrupt("return",Promise.all([this.participantsEntity.unsubscribe(),this.messagesEntity.unsubscribe()]));case 6:case"end":return t.stop()}}),t,this)})));return function(){return t.apply(this,arguments)}}()},{key:"_setStatus",value:function(t,e){var n=this;this.statusSource=e,this.channelState.status!==t&&(this.channelState.status=t,"joined"===t?this._subscribeStreams().catch((function(e){if(Mt.debug("ERROR while setting conversation status "+t,e),"disconnected"!==n.services.syncClient.connectionState)throw e})):this.entityPromise&&this._unsubscribe().catch((function(e){if(Mt.debug("ERROR while setting conversation status "+t,e),"disconnected"!==n.services.syncClient.connectionState)throw e})))}},{key:"_statusSource",value:function(){return this.statusSource}},{key:"_update",value:function(t){var e,r,i,a,s;Mt.trace("_update",t),n.preprocessUpdate(t,this.sid);for(var u=new Set,o=0,c=Object.keys(t);o<c.length;o++){var d=c[o],l=jt[d];if(l)switch(l){case jt.status:if(!t.status||"unknown"===t.status||this.channelState.status===t.status)break;this.channelState.status=t.status,u.add(l);break;case jt.attributes:if(Z(this.channelState.attributes,t.attributes))break;this.channelState.attributes=t.attributes,u.add(l);break;case jt.lastConsumedMessageIndex:if(void 0===t.lastConsumedMessageIndex||t.lastConsumedMessageIndex===this.channelState.lastReadMessageIndex)break;this.channelState.lastReadMessageIndex=t.lastConsumedMessageIndex,u.add("lastReadMessageIndex");break;case jt.lastMessage:if(this.channelState.lastMessage&&!t.lastMessage){delete this.channelState.lastMessage,u.add(l);break}this.channelState.lastMessage=this.channelState.lastMessage||{},void 0!==(null===(e=t.lastMessage)||void 0===e?void 0:e.index)&&t.lastMessage.index!==this.channelState.lastMessage.index&&(this.channelState.lastMessage.index=t.lastMessage.index,u.add(l)),void 0!==(null===(r=t.lastMessage)||void 0===r?void 0:r.timestamp)&&(null===(i=this.channelState.lastMessage)||void 0===i||null===(a=i.dateCreated)||void 0===a?void 0:a.getTime())!==t.lastMessage.timestamp.getTime()&&(this.channelState.lastMessage.dateCreated=t.lastMessage.timestamp,u.add(l)),Z(this.channelState.lastMessage,{})&&delete this.channelState.lastMessage;break;case jt.state:var f=t.state||void 0;if(void 0!==f&&(f.dateUpdated=new Date(f.dateUpdated)),Z(this.channelState.state,f))break;this.channelState.state=f,u.add(l);break;default:var p=t[d]instanceof Date,h=p&&(null===(s=this.channelState[l])||void 0===s?void 0:s.getTime())===t[d].getTime(),v=!p&&this[l]===t[d];if(h||v)break;this.channelState[l]=t[d],u.add(l)}}u.size>0&&this.emit("updated",{conversation:this,updateReasons:z.default(u)})}},{key:"_onMessageAdded",value:function(t){var e,n=Ut(this.participants.values());try{for(n.s();!(e=n.n()).done;){var r=e.value;if(r.identity===t.author){r._endTyping();break}}}catch(i){n.e(i)}finally{n.f()}this.emit("messageAdded",t)}},{key:"_setLastReadMessageIndex",value:function(){var t=E.default(A.default.mark((function t(e){var n;return A.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this.services.commandExecutor.mutateResource("post","".concat(this.configuration.links.myConversations,"/").concat(this.sid),{last_read_message_index:e});case 2:return n=t.sent,t.abrupt("return",n.unread_messages_count);case 4:case"end":return t.stop()}}),t,this)})));return function(e){return t.apply(this,arguments)}}()},{key:"add",value:function(){var t=E.default(A.default.mark((function t(e,n){return A.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",this.participantsEntity.add(e,n));case 1:case"end":return t.stop()}}),t,this)})));return function(e,n){return t.apply(this,arguments)}}()},{key:"addNonChatParticipant",value:function(){var t=E.default(A.default.mark((function t(e,n,r){return A.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",this.participantsEntity.addNonChatParticipant(e,n,r));case 1:case"end":return t.stop()}}),t,this)})));return function(e,n,r){return t.apply(this,arguments)}}()},{key:"advanceLastReadMessageIndex",value:function(){var t=E.default(A.default.mark((function t(e){return A.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this._subscribeStreams();case 2:if(!(e<this.lastReadMessageIndex)){t.next=6;break}return t.next=5,this._setLastReadMessageIndex(this.lastReadMessageIndex);case 5:return t.abrupt("return",t.sent);case 6:return t.next=8,this._setLastReadMessageIndex(e);case 8:return t.abrupt("return",t.sent);case 9:case"end":return t.stop()}}),t,this)})));return function(e){return t.apply(this,arguments)}}()},{key:"delete",value:function(){var t=E.default(A.default.mark((function t(){return A.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this.services.commandExecutor.mutateResource("delete",this.links.self);case 2:return t.abrupt("return",this);case 3:case"end":return t.stop()}}),t,this)})));return function(){return t.apply(this,arguments)}}()},{key:"getAttributes",value:function(){var t=E.default(A.default.mark((function t(){return A.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this._subscribe();case 2:return t.abrupt("return",this.attributes);case 3:case"end":return t.stop()}}),t,this)})));return function(){return t.apply(this,arguments)}}()},{key:"getMessages",value:function(){var t=E.default(A.default.mark((function t(e,n,r){return A.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this._subscribeStreams();case 2:return t.abrupt("return",this.messagesEntity.getMessages(e,n,r));case 3:case"end":return t.stop()}}),t,this)})));return function(e,n,r){return t.apply(this,arguments)}}()},{key:"getParticipants",value:function(){var t=E.default(A.default.mark((function t(){return A.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this._subscribeStreams();case 2:return t.abrupt("return",this.participantsEntity.getParticipants());case 3:case"end":return t.stop()}}),t,this)})));return function(){return t.apply(this,arguments)}}()},{key:"getParticipantsCount",value:function(){var t=E.default(A.default.mark((function t(){var e,n;return A.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return e=new rt(this.configuration.links.conversations).path(this.sid).build(),t.next=3,this.services.network.get(e);case 3:return n=t.sent,t.abrupt("return",n.body.participants_count);case 5:case"end":return t.stop()}}),t,this)})));return function(){return t.apply(this,arguments)}}()},{key:"getParticipantBySid",value:function(){var t=E.default(A.default.mark((function t(e){return A.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",this.participantsEntity.getParticipantBySid(e));case 1:case"end":return t.stop()}}),t,this)})));return function(e){return t.apply(this,arguments)}}()},{key:"getParticipantByIdentity",value:function(){var t=E.default(A.default.mark((function t(e){return A.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",this.participantsEntity.getParticipantByIdentity(e));case 1:case"end":return t.stop()}}),t,this)})));return function(e){return t.apply(this,arguments)}}()},{key:"getMessagesCount",value:function(){var t=E.default(A.default.mark((function t(){var e,n;return A.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return e=new rt(this.configuration.links.conversations).path(this.sid).build(),t.next=3,this.services.network.get(e);case 3:return n=t.sent,t.abrupt("return",n.body.messages_count);case 5:case"end":return t.stop()}}),t,this)})));return function(){return t.apply(this,arguments)}}()},{key:"getUnreadMessagesCount",value:function(){var t=E.default(A.default.mark((function t(){var e,n,r;return A.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return e=new rt(this.configuration.links.myConversations).path(this.sid).build(),t.next=3,this.services.network.get(e);case 3:if((n=t.sent).body.conversation_sid===this.sid){t.next=6;break}throw new Error("Conversation was not found in the user conversations list");case 6:if("number"!==typeof(r=n.body.unread_messages_count)){t.next=9;break}return t.abrupt("return",r);case 9:return t.abrupt("return",null);case 10:case"end":return t.stop()}}),t,this)})));return function(){return t.apply(this,arguments)}}()},{key:"join",value:function(){var t=E.default(A.default.mark((function t(){return A.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this.services.commandExecutor.mutateResource("post",this.links.participants,{identity:this.configuration.userIdentity});case 2:return t.abrupt("return",this);case 3:case"end":return t.stop()}}),t,this)})));return function(){return t.apply(this,arguments)}}()},{key:"leave",value:function(){var t=E.default(A.default.mark((function t(){return A.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if("joined"!==this.channelState.status){t.next=3;break}return t.next=3,this.services.commandExecutor.mutateResource("delete","".concat(this.links.participants,"/").concat(this.configuration.userIdentity));case 3:return t.abrupt("return",this);case 4:case"end":return t.stop()}}),t,this)})));return function(){return t.apply(this,arguments)}}()},{key:"removeParticipant",value:function(){var t=E.default(A.default.mark((function t(e){return A.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this.participantsEntity.remove("string"===typeof e?e:e.sid);case 2:case"end":return t.stop()}}),t,this)})));return function(e){return t.apply(this,arguments)}}()},{key:"sendMessage",value:function(){var t=E.default(A.default.mark((function t(e,n,r){var i,a;return A.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if("string"!==typeof e&&null!==e){t.next=5;break}return t.next=3,this.messagesEntity.send(e,n,r);case 3:return i=t.sent,t.abrupt("return",tt(i.index));case 5:return t.next=7,this.messagesEntity.sendMedia(e,n,r);case 7:return a=t.sent,t.abrupt("return",tt(a.index));case 9:case"end":return t.stop()}}),t,this)})));return function(e,n,r){return t.apply(this,arguments)}}()},{key:"prepareMessage",value:function(){return new Ot(this.limits,this.messagesEntity)}},{key:"setAllMessagesRead",value:function(){var t=E.default(A.default.mark((function t(){var e;return A.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this._subscribeStreams();case 2:return t.next=4,this.getMessages(1);case 4:if(!((e=t.sent).items.length>0)){t.next=7;break}return t.abrupt("return",this.advanceLastReadMessageIndex(e.items[0].index));case 7:return t.abrupt("return",Promise.resolve(0));case 8:case"end":return t.stop()}}),t,this)})));return function(){return t.apply(this,arguments)}}()},{key:"setAllMessagesUnread",value:function(){var t=E.default(A.default.mark((function t(){return A.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this._subscribeStreams();case 2:return t.next=4,this._setLastReadMessageIndex(null);case 4:return t.abrupt("return",t.sent);case 5:case"end":return t.stop()}}),t,this)})));return function(){return t.apply(this,arguments)}}()},{key:"setUserNotificationLevel",value:function(){var t=E.default(A.default.mark((function t(e){return A.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this.services.commandExecutor.mutateResource("post","".concat(this.configuration.links.myConversations,"/").concat(this.sid),{notification_level:e});case 2:case"end":return t.stop()}}),t,this)})));return function(e){return t.apply(this,arguments)}}()},{key:"typing",value:function(){return this.services.typingIndicator.send(this.sid)}},{key:"updateAttributes",value:function(){var t=E.default(A.default.mark((function t(e){return A.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this.services.commandExecutor.mutateResource("post",this.links.self,{attributes:void 0!==e?JSON.stringify(e):void 0});case 2:return t.abrupt("return",this);case 3:case"end":return t.stop()}}),t,this)})));return function(e){return t.apply(this,arguments)}}()},{key:"updateFriendlyName",value:function(){var t=E.default(A.default.mark((function t(e){return A.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(this.channelState.friendlyName===e){t.next=3;break}return t.next=3,this.services.commandExecutor.mutateResource("post",this.links.self,{friendly_name:e});case 3:return t.abrupt("return",this);case 4:case"end":return t.stop()}}),t,this)})));return function(e){return t.apply(this,arguments)}}()},{key:"updateLastReadMessageIndex",value:function(){var t=E.default(A.default.mark((function t(e){return A.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this._subscribeStreams();case 2:return t.abrupt("return",this._setLastReadMessageIndex(e));case 3:case"end":return t.stop()}}),t,this)})));return function(e){return t.apply(this,arguments)}}()},{key:"updateUniqueName",value:function(){var t=E.default(A.default.mark((function t(e){return A.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(this.channelState.uniqueName===e){t.next=4;break}return e||(e=""),t.next=4,this.services.commandExecutor.mutateResource("post",this.links.self,{unique_name:e});case 4:return t.abrupt("return",this);case 5:case"end":return t.stop()}}),t,this)})));return function(e){return t.apply(this,arguments)}}()}],[{key:"preprocessUpdate",value:function(t,e){try{"string"===typeof t.attributes?t.attributes=JSON.parse(t.attributes):t.attributes&&JSON.stringify(t.attributes)}catch(n){Mt.warn("Retrieved malformed attributes from the server for conversation: "+e),t.attributes={}}try{t.dateCreated&&(t.dateCreated=new Date(t.dateCreated))}catch(n){Mt.warn("Retrieved malformed dateCreated from the server for conversation: "+e),delete t.dateCreated}try{t.dateUpdated&&(t.dateUpdated=new Date(t.dateUpdated))}catch(n){Mt.warn("Retrieved malformed dateUpdated from the server for conversation: "+e),delete t.dateUpdated}try{t.lastMessage&&t.lastMessage.timestamp&&(t.lastMessage.timestamp=new Date(t.lastMessage.timestamp))}catch(n){Mt.warn("Retrieved malformed lastMessage.timestamp from the server for conversation: "+e),delete t.lastMessage.timestamp}}}]),n}(m.ReplayEventEmitter);M.default(Dt,"participantJoined","participantJoined"),M.default(Dt,"participantLeft","participantLeft"),M.default(Dt,"participantUpdated","participantUpdated"),M.default(Dt,"messageAdded","messageAdded"),M.default(Dt,"messageRemoved","messageRemoved"),M.default(Dt,"messageUpdated","messageUpdated"),M.default(Dt,"typingEnded","typingEnded"),M.default(Dt,"typingStarted","typingStarted"),M.default(Dt,"updated","updated"),M.default(Dt,"removed","removed"),J([y.validateTypesAsync(y.nonEmptyString,["undefined","string","number","boolean","object",y.literal(null)]),q("design:type",Function),q("design:paramtypes",[String,Object]),q("design:returntype",Promise)],Dt.prototype,"add",null),J([y.validateTypesAsync(y.nonEmptyString,y.nonEmptyString,["undefined","string","number","boolean","object",y.literal(null)]),q("design:type",Function),q("design:paramtypes",[String,String,Object]),q("design:returntype",Promise)],Dt.prototype,"addNonChatParticipant",null),J([y.validateTypesAsync(y.nonNegativeInteger),q("design:type",Function),q("design:paramtypes",[Number]),q("design:returntype",Promise)],Dt.prototype,"advanceLastReadMessageIndex",null),J([y.validateTypesAsync(["undefined",y.nonNegativeInteger],["undefined",y.nonNegativeInteger],["undefined",y.literal("backwards","forward")]),q("design:type",Function),q("design:paramtypes",[Number,Number,String]),q("design:returntype",Promise)],Dt.prototype,"getMessages",null),J([y.validateTypesAsync(y.nonEmptyString),q("design:type",Function),q("design:paramtypes",[String]),q("design:returntype",Promise)],Dt.prototype,"getParticipantBySid",null),J([y.validateTypesAsync(y.nonEmptyString),q("design:type",Function),q("design:paramtypes",[String]),q("design:returntype",Promise)],Dt.prototype,"getParticipantByIdentity",null),J([y.validateTypesAsync([y.nonEmptyString,pt]),q("design:type",Function),q("design:paramtypes",[Object]),q("design:returntype",Promise)],Dt.prototype,"removeParticipant",null),J([y.validateTypesAsync(["string",y.literal(null),y.custom((function(t){return[t instanceof FormData,"an instance of FormData"]})),y.objectSchema("media options",{contentType:y.nonEmptyString,media:y.custom((function(t){var e="string"===typeof t&&t.length>0||t instanceof Uint8Array||t instanceof ArrayBuffer;return"function"===typeof Blob&&(e=e||t instanceof Blob),[e,"a non-empty string, an instance of Buffer or an instance of Blob"]}))})],["undefined","string","number","boolean","object",y.literal(null)],["undefined",y.literal(null),y.objectSchema("email attributes",{subject:[y.nonEmptyString,"undefined"]})]),q("design:type",Function),q("design:paramtypes",[Object,Object,Object]),q("design:returntype",Promise)],Dt.prototype,"sendMessage",null),J([y.validateTypesAsync(y.literal("default","muted")),q("design:type",Function),q("design:paramtypes",[String]),q("design:returntype",Promise)],Dt.prototype,"setUserNotificationLevel",null),J([y.validateTypesAsync(["string","number","boolean","object",y.literal(null)]),q("design:type",Function),q("design:paramtypes",[Object]),q("design:returntype",Promise)],Dt.prototype,"updateAttributes",null),J([y.validateTypesAsync(["string"]),q("design:type",Function),q("design:paramtypes",[String]),q("design:returntype",Promise)],Dt.prototype,"updateFriendlyName",null),J([y.validateTypesAsync([y.literal(null),y.nonNegativeInteger]),q("design:type",Function),q("design:paramtypes",[Number]),q("design:returntype",Promise)],Dt.prototype,"updateLastReadMessageIndex",null),J([y.validateTypesAsync(["string",y.literal(null)]),q("design:type",Function),q("design:paramtypes",[String]),q("design:returntype",Promise)],Dt.prototype,"updateUniqueName",null);var Ft=function(){function t(){var e=this;j.default(this,t),this._promise=new Promise((function(t,n){e._resolve=t,e._reject=n}))}return T.default(t,[{key:"promise",get:function(){return this._promise}},{key:"update",value:function(t){this._resolve(t)}},{key:"set",value:function(t){this.current=t,this._resolve(t)}},{key:"fail",value:function(t){this._reject(t)}}]),t}();function Bt(t,e){var n="undefined"!==typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!n){if(Array.isArray(t)||(n=function(t,e){if(!t)return;if("string"===typeof t)return Lt(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);"Object"===n&&t.constructor&&(n=t.constructor.name);if("Map"===n||"Set"===n)return Array.from(t);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return Lt(t,e)}(t))||e&&t&&"number"===typeof t.length){n&&(t=n);var r=0,i=function(){};return{s:i,n:function(){return r>=t.length?{done:!0}:{done:!1,value:t[r++]}},e:function(t){throw t},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,s=!0,u=!1;return{s:function(){n=n.call(t)},n:function(){var t=n.next();return s=t.done,t},e:function(t){u=!0,a=t},f:function(){try{s||null==n.return||n.return()}finally{if(u)throw a}}}}function Lt(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,r=new Array(e);n<e;n++)r[n]=t[n];return r}function zt(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,r)}return n}function Jt(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?zt(Object(n),!0).forEach((function(e){M.default(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):zt(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}function qt(t){var e=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}();return function(){var n,r=N.default(t);if(e){var i=N.default(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return I.default(this,n)}}var Gt=V.scope("Conversations"),Kt=function(t){U.default(n,t);var e=qt(n);function n(t,r){var i;return j.default(this,n),i=e.call(this),M.default(O.default(i),"conversations",new Map),M.default(O.default(i),"myConversationsRead",new Ft),M.default(O.default(i),"tombstones",new Set),M.default(O.default(i),"myConversationsFetched",!1),i.configuration=t,i.services=r,i}return T.default(n,[{key:"addConversation",value:function(){var t=E.default(A.default.mark((function t(e){var n,r,i,a,s,u,o,c,d,l;return A.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return a="undefined"!==typeof(null===e||void 0===e?void 0:e.attributes)?e.attributes:{},t.next=3,this.services.commandExecutor.mutateResource("post",this.configuration.links.conversations,{friendly_name:e.friendlyName,unique_name:e.uniqueName,attributes:"undefined"!==typeof a?JSON.stringify(a):void 0});case 3:if(s=t.sent,u=null!==(n=s.sid)&&void 0!==n?n:null,o=null!==(r=null===(i=s.sync_objects)||void 0===i?void 0:i.conversation)&&void 0!==r?r:null,c=Jt({self:s.url},s.links),!(d=this.conversations.get(u))){t.next=12;break}return t.next=11,d._subscribe();case 11:return t.abrupt("return",d);case 12:return l=new Dt({channel:o,entityName:null,uniqueName:null,attributes:null,createdBy:null,friendlyName:null,lastConsumedMessageIndex:null,dateCreated:null,dateUpdated:null},u,c,this.configuration,this.services),this.conversations.set(l.sid,l),this._registerForEvents(l),t.next=17,l._subscribe();case 17:return this.emit("conversationAdded",l),t.abrupt("return",l);case 19:case"end":return t.stop()}}),t,this)})));return function(e){return t.apply(this,arguments)}}()},{key:"fetchConversations",value:function(){var t=E.default(A.default.mark((function t(){var e,n,r,i,a,s,u,o=this;return A.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,this._getMap();case 3:return(e=t.sent).on("itemAdded",(function(t){Gt.debug("itemAdded: ".concat(t.item.key)),o._upsertConversation("sync",t.item.key,t.item.data)})),e.on("itemRemoved",(function(t){Gt.debug("itemRemoved: ".concat(t.key));var e=t.key;o.myConversationsFetched||o.tombstones.add(e);var n=o.conversations.get(e);n&&("joined"===n.status&&(n._setStatus("notParticipating","sync"),o.emit("conversationLeft",n)),o.conversations.delete(e),o.emit("conversationRemoved",n),n.emit("removed",n))})),e.on("itemUpdated",(function(t){Gt.debug("itemUpdated: ".concat(t.item.key)),o._upsertConversation("sync",t.item.key,t.item.data)})),t.next=9,this._fetchMyConversations();case 9:n=t.sent,r=[],i=Bt(n);try{for(i.s();!(a=i.n()).done;)s=a.value,r.push(this._upsertConversation("rest",s.channel_sid,s))}catch(c){i.e(c)}finally{i.f()}return this.myConversationsRead.set(!0),t.next=16,Promise.all(r);case 16:return this.myConversationsFetched=!0,this.tombstones.clear(),Gt.debug("The conversations list has been successfully fetched"),t.abrupt("return",this);case 22:throw t.prev=22,t.t0=t.catch(0),u="Failed to fetch the conversations list","disconnected"!==this.services.syncClient.connectionState&&Gt.error(u,t.t0),Gt.debug("ERROR: ".concat(u),t.t0),t.t0;case 28:case"end":return t.stop()}}),t,this,[[0,22]])})));return function(){return t.apply(this,arguments)}}()},{key:"getConversations",value:function(){var t=E.default(A.default.mark((function t(e){var n,r,i=this;return A.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this._getMap();case 2:return n=t.sent,t.next=5,n.getItems();case 5:return r=t.sent,t.abrupt("return",this._wrapPaginator(r,(function(t){return Promise.all(t.map((function(t){return i._upsertConversation("sync",t.key,t.data)})))})));case 7:case"end":return t.stop()}}),t,this)})));return function(e){return t.apply(this,arguments)}}()},{key:"getConversation",value:function(){var t=E.default(A.default.mark((function t(e){var n,r,i,a=this;return A.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this._getMap();case 2:return n=t.sent,t.next=5,n.getItems({from:e});case 5:return r=t.sent,i=r.items.map((function(t){return a._upsertConversation("sync",t.key,t.data)})),t.abrupt("return",i.length>0?i[0]:null);case 8:case"end":return t.stop()}}),t,this)})));return function(e){return t.apply(this,arguments)}}()},{key:"getConversationByUniqueName",value:function(){var t=E.default(A.default.mark((function t(e){var n,r,i,a,s;return A.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n=new rt(this.configuration.links.myConversations).path(e).build(),t.next=3,this.services.network.get(n);case 3:return r=t.sent,i=r.body,a=i.conversation_sid,s={entityName:null,lastConsumedMessageIndex:i.last_read_message_index,status:(null===i||void 0===i?void 0:i.status)||"unknown",friendlyName:i.friendly_name,dateUpdated:i.date_updated,dateCreated:i.date_created,uniqueName:i.unique_name,createdBy:i.created_by,attributes:i.attributes,channel:i.sync_objects.conversation,notificationLevel:null===i||void 0===i?void 0:i.notification_level,sid:a},t.abrupt("return",this._upsertConversation("sync",a,s));case 8:case"end":return t.stop()}}),t,this)})));return function(e){return t.apply(this,arguments)}}()},{key:"peekConversation",value:function(){var t=E.default(A.default.mark((function t(e){var n,r,i,a;return A.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n=new rt(this.configuration.links.conversations).path(e).build(),t.next=3,this.services.network.get(n);case 3:return r=t.sent,i=r.body,a={entityName:null,status:(null===i||void 0===i?void 0:i.status)||"unknown",friendlyName:i.friendly_name,dateUpdated:i.date_updated,dateCreated:i.date_created,uniqueName:i.unique_name,createdBy:i.created_by,attributes:i.attributes,channel:"".concat(e,".channel"),sid:e},t.abrupt("return",this._upsertConversation("sync",e,a));case 7:case"end":return t.stop()}}),t,this)})));return function(e){return t.apply(this,arguments)}}()},{key:"_getMap",value:function(){var t=E.default(A.default.mark((function t(){return A.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this.services.syncClient.map({id:this.configuration.myConversations,mode:"open_existing"});case 2:return t.abrupt("return",t.sent);case 3:case"end":return t.stop()}}),t,this)})));return function(){return t.apply(this,arguments)}}()},{key:"_wrapPaginator",value:function(){var t=E.default(A.default.mark((function t(e,n){var r,i=this;return A.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,n(e.items);case 2:return r=t.sent,t.abrupt("return",{items:r,hasNextPage:e.hasNextPage,hasPrevPage:e.hasPrevPage,nextPage:function(){return e.nextPage().then((function(t){return i._wrapPaginator(t,n)}))},prevPage:function(){return e.prevPage().then((function(t){return i._wrapPaginator(t,n)}))}});case 4:case"end":return t.stop()}}),t)})));return function(e,n){return t.apply(this,arguments)}}()},{key:"_updateConversation",value:function(){var t=E.default(A.default.mark((function t(e,n,r){var i,a,s,u=this;return A.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(i=void 0!==n._statusSource()&&e!==n._statusSource(),a="rest"!==e||"sync"===n._statusSource(),!i||!a||"sync"===e){t.next=5;break}return Gt.trace("upsertConversation: conversation is known from sync and came from chat, ignoring",{sid:n.sid,data:r.status,conversation:n.status}),t.abrupt("return");case 5:if("joined"!==r.status||"joined"===n.status){t.next=13;break}return n._setStatus("joined",e),s={},"undefined"!==typeof r.notificationLevel&&(s.notificationLevel=r.notificationLevel),"undefined"!==typeof r.lastConsumedMessageIndex&&(s.lastConsumedMessageIndex=r.lastConsumedMessageIndex),Z(s,{})||n._update(s),n._subscribe().then((function(){u.emit("conversationJoined",n)})),t.abrupt("return");case 13:if("notParticipating"!==r.status||"joined"!==n.status){t.next=20;break}return n._setStatus("notParticipating",e),n._update(r),t.next=18,n._subscribe();case 18:return this.emit("conversationLeft",n),t.abrupt("return");case 20:if("notParticipating"!==r.status){t.next=24;break}return t.next=23,n._subscribe();case 23:return t.abrupt("return");case 24:n._update(r);case 25:case"end":return t.stop()}}),t,this)})));return function(e,n,r){return t.apply(this,arguments)}}()},{key:"_upsertConversation",value:function(){var t=E.default(A.default.mark((function t(e,n,r){var i,a,s,u;return A.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(Gt.trace("upsertConversation called for ".concat(n),r),!(i=this.conversations.get(n))){t.next=9;break}return Gt.trace("upsertConversation: the conversation ".concat(i.sid," is known;")+"its status is known from the source ".concat(i._statusSource()," ")+"and the update came from the source ".concat(e),i),t.next=6,this._updateConversation(e,i,r);case 6:return t.next=8,i._subscribe();case 8:return t.abrupt("return",i);case 9:if(!["chat","rest"].includes(e)||!this.tombstones.has(n)){t.next=12;break}return Gt.trace("upsertChannel: the channel is deleted but reappeared again from chat, ignoring",n),t.abrupt("return");case 12:return Gt.trace("upsertConversation: creating a local conversation object with sid "+n,r),a="".concat(this.configuration.links.conversations,"/").concat(n),s={self:a,messages:"".concat(a,"/Messages"),participants:"".concat(a,"/Participants")},u=new Dt(r,n,s,this.configuration,this.services),this.conversations.set(n,u),t.next=19,u._subscribe();case 19:return this._registerForEvents(u),this.emit("conversationAdded",u),"joined"===r.status&&(u._setStatus("joined",e),this.emit("conversationJoined",u)),t.abrupt("return",u);case 23:case"end":return t.stop()}}),t,this)})));return function(e,n,r){return t.apply(this,arguments)}}()},{key:"_fetchMyConversations",value:function(){var t=E.default(A.default.mark((function t(){var e,n,r,i,a;return A.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:e=[],n=null;case 2:return r=new rt(this.configuration.links.myConversations),n&&r.arg("PageToken",n),t.next=6,this.services.network.get(r.build());case 6:i=t.sent,a=i.body.conversations.map((function(t){return{descriptor:t,channel_sid:t.conversation_sid,status:t.status,channel:t.sync_objects.conversation,messages:t.sync_objects.messages,roster:"".concat(t.conversation_sid,".roster"),lastConsumedMessageIndex:t.last_consumed_message_index,notificationLevel:t.notification_level}})),n=i.body.meta.next_token,e=[].concat(z.default(e),z.default(a));case 10:if(n){t.next=2;break}case 11:return t.abrupt("return",e);case 12:case"end":return t.stop()}}),t,this)})));return function(){return t.apply(this,arguments)}}()},{key:"_onConversationRemoved",value:function(t){var e=this.conversations.get(t);e&&(this.conversations.delete(t),this.emit("conversationRemoved",e))}},{key:"_registerForEvents",value:function(t){var e=this;t.on("removed",(function(){return e._onConversationRemoved(t.sid)})),t.on("updated",(function(t){return e.emit("conversationUpdated",t)})),t.on("participantJoined",this.emit.bind(this,"participantJoined")),t.on("participantLeft",this.emit.bind(this,"participantLeft")),t.on("participantUpdated",(function(t){return e.emit("participantUpdated",t)})),t.on("messageAdded",this.emit.bind(this,"messageAdded")),t.on("messageUpdated",(function(t){return e.emit("messageUpdated",t)})),t.on("messageRemoved",this.emit.bind(this,"messageRemoved")),t.on("typingStarted",this.emit.bind(this,"typingStarted")),t.on("typingEnded",this.emit.bind(this,"typingEnded"))}}]),n}(m.ReplayEventEmitter);function Vt(t){var e=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}();return function(){var n,r=N.default(t);if(e){var i=N.default(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return I.default(this,n)}}var Wt=function(t){U.default(n,t);var e=Vt(n);function n(t,r,i){var a;return j.default(this,n),(a=e.call(this)).configuration=r,a.services=i,a.fifoStack=[],a.myself=t,a.myself.on("updated",(function(t){return a.emit("userUpdated",t)})),a.myself.on("userSubscribed",(function(){return a.emit("userSubscribed",a.myself)})),a.myself.on("userUnsubscribed",(function(){a.emit("userUnsubscribed",a.myself),a.myself._ensureFetched()})),a.subscribedUsers=new Map,a}return T.default(n,[{key:"handleUnsubscribeUser",value:function(t){this.subscribedUsers.has(t.identity)&&this.subscribedUsers.delete(t.identity);var e=-1;this.fifoStack.find((function(n,r){return n==t.identity&&(e=r,!0)}))&&this.fifoStack.splice(e,1),this.emit("userUnsubscribed",t)}},{key:"handleSubscribeUser",value:function(t){this.subscribedUsers.has(t.identity)||(this.fifoStack.length>=this.configuration.userInfosToSubscribe&&this.subscribedUsers.get(this.fifoStack.shift()).unsubscribe(),this.fifoStack.push(t.identity),this.subscribedUsers.set(t.identity,t),this.emit("userSubscribed",t))}},{key:"getUser",value:function(){var t=E.default(A.default.mark((function t(e){var n,r,i=this,a=arguments;return A.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n=a.length>1&&void 0!==a[1]?a[1]:null,t.next=3,this.myself._ensureFetched();case 3:if(e!=this.myself.identity){t.next=5;break}return t.abrupt("return",this.myself);case 5:if(r=this.subscribedUsers.get(e)){t.next=17;break}if(n){t.next=11;break}return t.next=10,this.getSyncUniqueName(e);case 10:n=t.sent;case 11:return(r=new st(e,n,this.configuration,this.services)).on("updated",(function(t){return i.emit("userUpdated",t)})),r.on("userSubscribed",(function(){return i.handleSubscribeUser(r)})),r.on("userUnsubscribed",(function(){return i.handleUnsubscribeUser(r)})),t.next=17,r._ensureFetched();case 17:return t.abrupt("return",r);case 18:case"end":return t.stop()}}),t,this)})));return function(e){return t.apply(this,arguments)}}()},{key:"getSubscribedUsers",value:function(){var t=E.default(A.default.mark((function t(){var e;return A.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this.myself._ensureFetched();case 2:return e=[this.myself],this.subscribedUsers.forEach((function(t){return e.push(t)})),t.abrupt("return",e);case 5:case"end":return t.stop()}}),t,this)})));return function(){return t.apply(this,arguments)}}()},{key:"getSyncUniqueName",value:function(){var t=E.default(A.default.mark((function t(e){var n,r;return A.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n=new rt(this.configuration.links.users).path(e).build(),t.next=3,this.services.network.get(n);case 3:return r=t.sent,t.abrupt("return",r.body.sync_objects.user_info_map);case 5:case"end":return t.stop()}}),t,this)})));return function(e){return t.apply(this,arguments)}}()}]),n}(m.ReplayEventEmitter),$t=V.scope("TypingIndicator"),Yt=function(){function t(e,n,r){j.default(this,t),this.configuration=n,this.services=r,this.getConversation=e,this.serviceTypingTimeout=null,this.sentUpdates=new Map}return T.default(t,[{key:"typingTimeout",get:function(){return this.configuration.typingIndicatorTimeoutOverride||this.serviceTypingTimeout||this.configuration.typingIndicatorTimeoutDefault}},{key:"initialize",value:function(){var t=this;this.services.notificationClient.on("message",function(){var e=E.default(A.default.mark((function e(n,r){return A.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n!==dt.TYPING_INDICATOR){e.next=3;break}return e.next=3,t._handleRemoteTyping(r);case 3:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}())}},{key:"_handleRemoteTyping",value:function(){var t=E.default(A.default.mark((function t(e){var n=this;return A.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:$t.trace("Got new typing indicator ",e),this.getConversation(e.channel_sid).then((function(t){t&&t.participants.forEach((function(t){if(t.identity===e.identity){var r=n.configuration.typingIndicatorTimeoutOverride+1e3||1e3*e.typing_timeout;t._startTyping(r)}}))})).catch((function(t){throw $t.error(t),t}));case 2:case"end":return t.stop()}}),t,this)})));return function(e){return t.apply(this,arguments)}}()},{key:"send",value:function(t){var e=this.sentUpdates.get(t);return e&&e>Date.now()-this.typingTimeout?Promise.resolve():(this.sentUpdates.set(t,Date.now()),this._send(t))}},{key:"_send",value:function(t){var e=this;$t.trace("Sending typing indicator");var n=this.configuration.links.typing,r="ChannelSid=".concat(t);return this.services.twilsockClient.post(n,{"Content-Type":"application/x-www-form-urlencoded"},r,this.configuration.productId).then((function(t){t.body.hasOwnProperty("typing_timeout")&&(e.serviceTypingTimeout=1e3*t.body.typing_timeout)})).catch((function(t){throw $t.error("Failed to send typing indicator:",t),t}))}}]),t}(),Ht=function t(e){j.default(this,t),this.title=e.title||null,this.body=e.body||null,this.sound=e.sound||null,this.badge=e.badge||null,this.action=e.action||null,this.type=e.type||null,this.data=e.data||{}};function Xt(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,r)}return n}function Zt(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?Xt(Object(n),!0).forEach((function(e){M.default(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):Xt(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}var Qt,te,ee,ne=function(t){return t.replace(/(^\/+|\/+$)/g,"")},re=function(){function t(e,n,r){j.default(this,t),this._serviceUrl=e,this._services=n,this._productId=r}return T.default(t,[{key:"_preProcessUrl",value:function(t){var e=ne(t);return/^https?:\/\//.test(t)?e:"".concat(ne(this._serviceUrl),"/").concat(e)}},{key:"_makeRequest",value:function(){var t=E.default(A.default.mark((function t(e,n,r,i){var a,s,u,o;return A.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:a=this._preProcessUrl(n),s=Zt({"Content-Type":"application/json; charset=utf-8"},i||{}),t.t0=e,t.next="get"===t.t0?5:"post"===t.t0?11:"delete"===t.t0?15:19;break;case 5:return o=a,r&&(o+="?"+Object.entries(r).map((function(t){return t.map(encodeURIComponent).join("=")})).join("&")),t.next=9,this._services.transport.get(o,s,this._productId);case 9:return u=t.sent,t.abrupt("break",19);case 11:return t.next=13,this._services.transport.post(a,s,JSON.stringify(r),this._productId);case 13:return u=t.sent,t.abrupt("break",19);case 15:return t.next=17,this._services.transport.delete(a,s,null,this._productId);case 17:return u=t.sent,t.abrupt("break",19);case 19:if(!(u.status.code<200||u.status.code>=300)){t.next=21;break}throw new Error("Request responded with a non-success code ".concat(u.status.code));case 21:return t.abrupt("return",u);case 22:case"end":return t.stop()}}),t,this)})));return function(e,n,r,i){return t.apply(this,arguments)}}()},{key:"fetchResource",value:function(){var t=E.default(A.default.mark((function t(e,n){var r,i=this;return A.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return 6,t.prev=1,t.next=4,new b.AsyncRetrier({min:50,max:1600,maxAttemptsCount:6}).run((function(){return i._makeRequest("get",e,n)}));case 4:r=t.sent,t.next=10;break;case 7:throw t.prev=7,t.t0=t.catch(1),new Error('Fetch resource from "'.concat(e,'" failed.'));case 10:return t.abrupt("return",r.body);case 11:case"end":return t.stop()}}),t,null,[[1,7]])})));return function(e,n){return t.apply(this,arguments)}}()},{key:"mutateResource",value:function(){var t=E.default(A.default.mark((function t(e,n,r){var i;return A.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this._makeRequest(e,n,r,{"X-Twilio-Mutation-Id":C.v4()});case 2:if(i=t.sent,202!==i.status.code){t.next=7;break}return t.next=6,this.fetchResource(i.body.resource_url);case 6:return t.abrupt("return",t.sent);case 7:return t.abrupt("return",i.body);case 8:case"end":return t.stop()}}),t,this)})));return function(e,n,r){return t.apply(this,arguments)}}()}]),t}();function ie(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,r)}return n}function ae(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?ie(Object(n),!0).forEach((function(e){M.default(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):ie(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}function se(t){var e=function(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}();return function(){var n,r=N.default(t);if(e){var i=N.default(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return I.default(this,n)}}var ue=V.scope("Client"),oe="2.0.0",ce=function t(){j.default(this,t)};e.KU=(te=Qt=function(t){U.default(n,t);var e=se(n);function n(t){var r,i,a,s,u,o,c=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(j.default(this,n),o=e.call(this),M.default(O.default(o),"connectionState","unknown"),M.default(O.default(o),"conversationsPromise",null),M.default(O.default(o),"_ensureReady",null),M.default(O.default(o),"_resolveEnsureReady",null),M.default(O.default(o),"_rejectEnsureReady",null),M.default(O.default(o),"version",oe),M.default(O.default(o),"parsePushNotification",ee.parsePushNotification),o.fpaToken=t,o.options=c,!o.options.disableDeepClone){var d=ae(ae({},o.options),{},{transport:void 0,twilsockClient:void 0});(d=Q(d)).transport=o.options.transport,d.twilsockClient=o.options.twilsockClient,o.options=d}o.options.logLevel=null!==(r=o.options.logLevel)&&void 0!==r?r:"silent",ue.setLevel(o.options.logLevel);var l=o.options.productId="ip_messaging";if(o.options.clientMetadata=o.options.clientMetadata||{},o.options.clientMetadata.hasOwnProperty("type")||(o.options.clientMetadata.type="conversations"),o.options.clientMetadata.hasOwnProperty("sdk")||(o.options.clientMetadata.sdk="JS",o.options.clientMetadata.sdkv=oe),o.options.Sync=o.options.Sync||{},"undefined"===typeof o.options.Sync.enableSessionStorage&&(o.options.Sync.enableSessionStorage=!0),o.options.region&&(o.options.Sync.region=o.options.region),!t)throw new Error("A valid Twilio token should be provided");o.services=new ce,o._myself=new st("","",null,o.services);var f=!o.options.twilsockClient;if(!o.options.initRegistrations){var p=new k.InitRegistration(l);ee.populateInitRegistrations(p),o.options.initRegistrations=[p]}o.services.twilsockClient=o.options.twilsockClient=null!==(i=o.options.twilsockClient)&&void 0!==i?i:new k.TwilsockClient(t,l,o.options),o.services.twilsockClient.on("tokenAboutToExpire",(function(t){return o.emit("tokenAboutToExpire",t)})),o.services.twilsockClient.on("tokenExpired",(function(){return o.emit("tokenExpired")})),o.services.twilsockClient.on("connectionError",(function(t){return o.emit("connectionError",t)})),o.services.twilsockClient.on("stateChanged",(function(t){ue.debug("Handling stateChanged for ConversationsClient: new state ".concat(t)),t!==o.connectionState&&(o.connectionState=t,o.emit("connectionStateChanged",o.connectionState))})),o.services.transport=o.options.transport=null!==(a=o.options.transport)&&void 0!==a?a:o.options.twilsockClient,o.services.notificationClient=o.options.notificationsClient=null!==(s=o.options.notificationsClient)&&void 0!==s?s:new w.Notifications(t,o.options),o.services.syncClient=o.options.syncClient=null!==(u=o.options.syncClient)&&void 0!==u?u:new x.SyncClient(t,o.options);var h=c.Chat||c.IPMessaging||c||{},v=h.region||c.region,y=h.apiUri||h.typingUri||"https://aim.".concat(v||"us1",".twilio.com");o.services.commandExecutor=new re(y,{transport:o.options.transport},l);var m=function(t){o._rejectEnsureReady(t),o.emit("stateChanged","failed")};return o.services.twilsockClient.once("connectionError",m),o.services.twilsockClient.once("disconnected",m),o.services.twilsockClient.once("connected",E.default(A.default.mark((function t(){var e;return A.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return ue.debug("ConversationsClient started INITIALIZING"),o.services.twilsockClient.off("connectionError",m),o.services.twilsockClient.off("disconnected",m),t.prev=3,e="conversations.client.startup",o.services.twilsockClient.addPartialTelemetryEvent(new k.TelemetryEventDescription(e,"Conversations client startup",new Date),e,k.TelemetryPoint.Start),t.next=8,o._initialize();case 8:o.services.twilsockClient.addPartialTelemetryEvent(new k.TelemetryEventDescription("","",new Date),e,k.TelemetryPoint.End),t.next=15;break;case 11:t.prev=11,t.t0=t.catch(3),o._rejectEnsureReady(t.t0),o.emit("stateChanged","failed");case 15:case"end":return t.stop()}}),t,null,[[3,11]])})))),o._ensureReady=new Promise((function(t,e){o._resolveEnsureReady=t,o._rejectEnsureReady=e})).catch((function(t){})),f&&o.services.twilsockClient.connect(),o}return T.default(n,[{key:"user",get:function(){return this._myself}},{key:"reachabilityEnabled",get:function(){if(!this.configuration)throw new Error("Reachability information could not yet be accessed as the client has not yet been initialized. Subscribe to the 'stateChanged' event to properly react to the client initialization.");return this.configuration.reachabilityEnabled}},{key:"token",get:function(){return this.fpaToken}},{key:"_subscribeToPushNotifications",value:function(t){var e=this;[dt.NEW_MESSAGE,dt.ADDED_TO_CONVERSATION,dt.REMOVED_FROM_CONVERSATION,dt.TYPING_INDICATOR,dt.CONSUMPTION_UPDATE].forEach((function(n){e.services.notificationClient.subscribe(t,n)}))}},{key:"_unsubscribeFromPushNotifications",value:function(t){var e=this;[dt.NEW_MESSAGE,dt.ADDED_TO_CONVERSATION,dt.REMOVED_FROM_CONVERSATION,dt.TYPING_INDICATOR,dt.CONSUMPTION_UPDATE].forEach((function(n){e.services.notificationClient.unsubscribe(t,n)}))}},{key:"_initialize",value:function(){var t=E.default(A.default.mark((function t(){var e,n=this;return A.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this.services.commandExecutor.fetchResource("Client/v2/Configuration");case 2:return e=t.sent,this.configuration=new X(this.options,e,ue),this._myself._resolveInitialization(this.configuration,this.configuration.userIdentity,this.configuration.userInfo,!0),this.services.typingIndicator=new Yt(this.getConversationBySid.bind(this),this.configuration,this.services),this.services.network=new ct(this.configuration,this.services),this.services.users=new Wt(this._myself,this.configuration,this.services),this.services.users.on("userSubscribed",this.emit.bind(this,"userSubscribed")),this.services.users.on("userUpdated",(function(t){return n.emit("userUpdated",t)})),this.services.users.on("userUnsubscribed",this.emit.bind(this,"userUnsubscribed")),this.conversations=new Kt(this.configuration,this.services),this.conversations.on("conversationAdded",this.emit.bind(this,"conversationAdded")),this.conversations.on("conversationRemoved",this.emit.bind(this,"conversationRemoved")),this.conversations.on("conversationJoined",this.emit.bind(this,"conversationJoined")),this.conversations.on("conversationLeft",this.emit.bind(this,"conversationLeft")),this.conversations.on("conversationUpdated",(function(t){return n.emit("conversationUpdated",t)})),this.conversations.on("participantJoined",this.emit.bind(this,"participantJoined")),this.conversations.on("participantLeft",this.emit.bind(this,"participantLeft")),this.conversations.on("participantUpdated",(function(t){return n.emit("participantUpdated",t)})),this.conversations.on("messageAdded",this.emit.bind(this,"messageAdded")),this.conversations.on("messageUpdated",(function(t){return n.emit("messageUpdated",t)})),this.conversations.on("messageRemoved",this.emit.bind(this,"messageRemoved")),this.conversations.on("typingStarted",this.emit.bind(this,"typingStarted")),this.conversations.on("typingEnded",this.emit.bind(this,"typingEnded")),this.conversationsPromise=this.conversations.fetchConversations().then((function(){return n.conversations})).catch((function(t){throw t})),t.next=28,this.services.users.myself._ensureFetched();case 28:ee.supportedPushChannels.forEach((function(t){return n._subscribeToPushNotifications(t)})),this.services.typingIndicator.initialize(),this.services.mcsClient=new _.McsClient(this.fpaToken,this.configuration.links.mediaService,this.configuration.links.mediaSetService,ae(ae({},this.options),{},{transport:null})),this._resolveEnsureReady(),this.emit("stateChanged","initialized");case 33:case"end":return t.stop()}}),t,this)})));return function(){return t.apply(this,arguments)}}()},{key:"shutdown",value:function(){var t=E.default(A.default.mark((function t(){return A.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this._ensureReady;case 2:return t.next=4,this.services.twilsockClient.disconnect();case 4:case"end":return t.stop()}}),t,this)})));return function(){return t.apply(this,arguments)}}()},{key:"updateToken",value:function(){var t=E.default(A.default.mark((function t(e){return A.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this._ensureReady;case 2:if(ue.info("updateToken"),this.fpaToken!==e){t.next=5;break}return t.abrupt("return",this);case 5:return t.next=7,this.services.twilsockClient.updateToken(e);case 7:return t.next=9,this.services.notificationClient.updateToken(e);case 9:return t.next=11,this.services.mcsClient.updateToken(e);case 11:return this.fpaToken=e,t.abrupt("return",this);case 13:case"end":return t.stop()}}),t,this)})));return function(e){return t.apply(this,arguments)}}()},{key:"getConversationBySid",value:function(){var t=E.default(A.default.mark((function t(e){var n;return A.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this._ensureReady;case 2:return t.next=4,this.conversations.myConversationsRead.promise;case 4:return t.next=6,this.conversations.getConversation(e);case 6:if(n=t.sent){t.next=11;break}return t.next=10,this.conversations.peekConversation(e);case 10:n=t.sent;case 11:if(n){t.next=13;break}throw new Error("Conversation with SID ".concat(e," is not found."));case 13:return t.abrupt("return",n);case 14:case"end":return t.stop()}}),t,this)})));return function(e){return t.apply(this,arguments)}}()},{key:"getConversationByUniqueName",value:function(){var t=E.default(A.default.mark((function t(e){var n;return A.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this._ensureReady;case 2:return t.next=4,this.conversations.myConversationsRead.promise;case 4:return t.next=6,this.conversations.getConversationByUniqueName(e);case 6:if(n=t.sent){t.next=9;break}throw new Error("Conversation with unique name ".concat(e," is not found."));case 9:return t.abrupt("return",n);case 10:case"end":return t.stop()}}),t,this)})));return function(e){return t.apply(this,arguments)}}()},{key:"getSubscribedConversations",value:function(){var t=E.default(A.default.mark((function t(e){return A.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this._ensureReady;case 2:return t.abrupt("return",this.conversationsPromise.then((function(t){return t.getConversations(e)})));case 3:case"end":return t.stop()}}),t,this)})));return function(e){return t.apply(this,arguments)}}()},{key:"createConversation",value:function(){var t=E.default(A.default.mark((function t(e){return A.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this._ensureReady;case 2:return e=e||{},t.abrupt("return",this.conversationsPromise.then((function(t){return t.addConversation(e)})));case 4:case"end":return t.stop()}}),t,this)})));return function(e){return t.apply(this,arguments)}}()},{key:"setPushRegistrationId",value:function(){var t=E.default(A.default.mark((function t(e,n){return A.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this._ensureReady;case 2:return this._subscribeToPushNotifications(e),this.services.notificationClient.setPushRegistrationId(e,n),t.next=6,this.services.notificationClient.commitChanges();case 6:case"end":return t.stop()}}),t,this)})));return function(e,n){return t.apply(this,arguments)}}()},{key:"unsetPushRegistrationId",value:function(){var t=E.default(A.default.mark((function t(e){return A.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this._ensureReady;case 2:return this._unsubscribeFromPushNotifications(e),t.next=5,this.services.notificationClient.commitChanges();case 5:case"end":return t.stop()}}),t,this)})));return function(e){return t.apply(this,arguments)}}()},{key:"removePushRegistrations",value:function(){var t=E.default(A.default.mark((function t(e,n){return A.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this.services.notificationClient.removeRegistrations(e,n);case 2:case"end":return t.stop()}}),t,this)})));return function(e,n){return t.apply(this,arguments)}}()},{key:"handlePushNotification",value:function(){var t=E.default(A.default.mark((function t(e){return A.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this._ensureReady;case 2:ue.debug("handlePushNotification, notificationPayload=",e),this.emit("pushNotification",ee.parsePushNotification(e));case 4:case"end":return t.stop()}}),t,this)})));return function(e){return t.apply(this,arguments)}}()},{key:"getUser",value:function(){var t=E.default(A.default.mark((function t(e){return A.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this._ensureReady;case 2:return t.abrupt("return",this.services.users.getUser(e));case 3:case"end":return t.stop()}}),t,this)})));return function(e){return t.apply(this,arguments)}}()},{key:"getSubscribedUsers",value:function(){var t=E.default(A.default.mark((function t(){return A.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this._ensureReady;case 2:return t.abrupt("return",this.services.users.getSubscribedUsers());case 3:case"end":return t.stop()}}),t,this)})));return function(){return t.apply(this,arguments)}}()}],[{key:"populateInitRegistrations",value:function(t){t.populateInitRegistrations([dt.TYPING_INDICATOR]),x.SyncClient.populateInitRegistrations(t)}},{key:"create",value:function(){var t=E.default(A.default.mark((function t(e,n){var r;return A.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(null===n||void 0===n||!n.twilsockClient){t.next=2;break}throw new Error("Obsolete usage of ConversationsClient.create() factory method: if you pass twilsock from the outside then you must use ConversationsClient constructor and be prepared to work with uninitialized client.");case 2:return r=new ee(e,n),t.next=5,r._ensureReady;case 5:return t.abrupt("return",r);case 6:case"end":return t.stop()}}),t)})));return function(e,n){return t.apply(this,arguments)}}()},{key:"parsePushNotificationChatData",value:function(t){var e={};for(var n in ee.supportedPushDataFields)"undefined"!==typeof t[n]&&null!==t[n]&&("message_index"===n?null!==tt(t[n])&&(e[ee.supportedPushDataFields[n]]=Number(t[n])):e[ee.supportedPushDataFields[n]]=t[n]);return e}},{key:"parsePushNotification",value:function(t){if(ue.debug("parsePushNotification, notificationPayload=",t),"undefined"!==typeof t.aps){if(!t.twi_message_type)throw new Error("Provided push notification payload does not contain Programmable Chat push notification type");var e=ee.parsePushNotificationChatData(t),n=t.aps,r=null,i=null;return"string"===typeof n.alert?r=n.alert||null:(r=n.alert.body||null,i=n.alert.title||null),new Ht({title:i,body:r,sound:n.sound||null,badge:n.badge||null,action:n.category||null,type:t.twi_message_type,data:e})}if("undefined"!==typeof t.data){var a=t.data;if(!a.twi_message_type)throw new Error("Provided push notification payload does not contain Programmable Chat push notification type");var s=ee.parsePushNotificationChatData(t.data);return new Ht({title:a.twi_title||null,body:a.twi_body||null,sound:a.twi_sound||null,badge:null,action:a.twi_action||null,type:a.twi_message_type,data:s})}throw new Error("Provided push notification payload is not Programmable Chat notification")}}]),n}(m.ReplayEventEmitter),M.default(Qt,"version",oe),M.default(Qt,"supportedPushChannels",["fcm","apn"]),M.default(Qt,"supportedPushDataFields",{conversation_sid:"conversationSid",message_sid:"messageSid",message_index:"messageIndex"}),M.default(Qt,"conversationAdded","conversationAdded"),M.default(Qt,"conversationJoined","conversationJoined"),M.default(Qt,"conversationLeft","conversationLeft"),M.default(Qt,"conversationRemoved","conversationRemoved"),M.default(Qt,"conversationUpdated","conversationUpdated"),M.default(Qt,"participantJoined","participantJoined"),M.default(Qt,"participantLeft","participantLeft"),M.default(Qt,"participantUpdated","participantUpdated"),M.default(Qt,"messageAdded","messageAdded"),M.default(Qt,"messageRemoved","messageRemoved"),M.default(Qt,"messageUpdated","messageUpdated"),M.default(Qt,"tokenAboutToExpire","tokenAboutToExpire"),M.default(Qt,"tokenExpired","tokenExpired"),M.default(Qt,"typingEnded","typingEnded"),M.default(Qt,"typingStarted","typingStarted"),M.default(Qt,"pushNotification","pushNotification"),M.default(Qt,"userSubscribed","userSubscribed"),M.default(Qt,"userUnsubscribed","userUnsubscribed"),M.default(Qt,"userUpdated","userUpdated"),M.default(Qt,"stateChanged","stateChanged"),M.default(Qt,"connectionStateChanged","connectionStateChanged"),M.default(Qt,"connectionError","connectionError"),ee=te),J([y.validateTypesAsync(y.nonEmptyString),q("design:type",Function),q("design:paramtypes",[String]),q("design:returntype",Promise)],e.KU.prototype,"updateToken",null),J([y.validateTypesAsync(y.nonEmptyString),q("design:type",Function),q("design:paramtypes",[String]),q("design:returntype",Promise)],e.KU.prototype,"getConversationBySid",null),J([y.validateTypesAsync(y.nonEmptyString),q("design:type",Function),q("design:paramtypes",[String]),q("design:returntype",Promise)],e.KU.prototype,"getConversationByUniqueName",null),J([y.validateTypesAsync(["undefined",y.objectSchema("conversation options",{friendlyName:["string","undefined"],isPrivate:["boolean","undefined"],uniqueName:["string","undefined"]})]),q("design:type",Function),q("design:paramtypes",[Object]),q("design:returntype",Promise)],e.KU.prototype,"createConversation",null),J([y.validateTypesAsync(y.literal("fcm","apn"),"string"),q("design:type",Function),q("design:paramtypes",[String,String]),q("design:returntype",Promise)],e.KU.prototype,"setPushRegistrationId",null),J([y.validateTypesAsync(y.literal("fcm","apn")),q("design:type",Function),q("design:paramtypes",[String]),q("design:returntype",Promise)],e.KU.prototype,"unsetPushRegistrationId",null),J([y.validateTypesAsync(y.literal("fcm","apn"),y.nonEmptyString),q("design:type",Function),q("design:paramtypes",[String,String]),q("design:returntype",Promise)],e.KU.prototype,"removePushRegistrations",null),J([y.validateTypesAsync(y.pureObject),q("design:type",Function),q("design:paramtypes",[Object]),q("design:returntype",Promise)],e.KU.prototype,"handlePushNotification",null),J([y.validateTypesAsync(y.nonEmptyString),q("design:type",Function),q("design:paramtypes",[String]),q("design:returntype",Promise)],e.KU.prototype,"getUser",null),J([y.validateTypesAsync("string",["undefined",y.pureObject]),q("design:type",Function),q("design:paramtypes",[String,Object]),q("design:returntype",Promise)],e.KU,"create",null),J([y.validateTypes(y.pureObject),q("design:type",Function),q("design:paramtypes",[Object]),q("design:returntype",Ht)],e.KU,"parsePushNotification",null),e.KU=ee=J([y.validateConstructorTypes(y.nonEmptyString,[y.pureObject,"undefined"]),q("design:paramtypes",[String,Object])],e.KU)}}]);